<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Log.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Log.cxx</h1><a href="_log_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00002 <span class="comment">/*                                  Log.cxx                                   */</span>
00003 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00004 <span class="comment">/* Task            : Task logging interface file.                             */</span>
00005 <span class="comment">/* Author          : Jurgen Knodlseder CESR (C) (all rights reserved)         */</span>
00006 <span class="comment">/* Revision        : 1.0.0                                                    */</span>
00007 <span class="comment">/* Date of version : 20-May-2005                                              */</span>
00008 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00009 <span class="comment">/* History :                                                                  */</span>
00010 <span class="comment">/* 1.0.0  20-May-2005  first version                                          */</span>
00011 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00012 
00013 <span class="comment">/* Includes _________________________________________________________________ */</span>
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>      <span class="comment">// for "FILE" type</span>
00015 <span class="preprocessor">#include &lt;string.h&gt;</span>     <span class="comment">// for "memcpy" function</span>
00016 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>     <span class="comment">// for "va_list" type</span>
00017 <span class="preprocessor">#include &lt;time.h&gt;</span>       <span class="comment">// for time functions</span>
00018 <span class="preprocessor">#include "<a class="code" href="source_identify_8h.html">sourceIdentify.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="_log_8h.html">Log.h</a>"</span>
00020 
00021 
00022 <span class="comment">/* Namespace definition _____________________________________________________ */</span>
00023 <span class="keyword">namespace </span>sourceIdentify {
00024 
00025 
00026 <span class="comment">/* Globals __________________________________________________________________ */</span>
<a name="l00027"></a><a class="code" href="namespacesource_identify.html#a6">00027</a> <span class="keywordtype">char</span>  <a class="code" href="namespacesource_identify.html#a6">gLogTaskName</a>[100];
<a name="l00028"></a><a class="code" href="namespacesource_identify.html#a7">00028</a> FILE *<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> = NULL;
00029 
00030 
00031 <span class="comment">/* Type defintions __________________________________________________________ */</span>
00032 
00033 
00034 <span class="comment">/* Prototypes _______________________________________________________________ */</span>
00035 
00036 
00037 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00038 <span class="comment">/*                                  LogInit                                   */</span>
00039 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00040 <span class="comment">/* Task: Initialise task logging.                                             */</span>
00041 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00042"></a><a class="code" href="namespacesource_identify.html#a34">00042</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> <a class="code" href="namespacesource_identify.html#a34">LogInit</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *logName, <span class="keyword">const</span> <span class="keywordtype">char</span> *taskName, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00043 
00044     <span class="comment">// Declare (and initialise) variables</span>
00045 
00046     <span class="comment">// Main do-loop to fall through in case of an error</span>
00047     <span class="keywordflow">do</span> {
00048     
00049       <span class="comment">// Clean log task name</span>
00050       sprintf(<a class="code" href="namespacesource_identify.html#a6">gLogTaskName</a>, <span class="stringliteral">""</span>);
00051     
00052       <span class="comment">// If there is already a log file opened then close it first</span>
00053       <span class="keywordflow">if</span> (<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> != NULL) {
00054         status = <a class="code" href="namespacesource_identify.html#a35">LogClose</a>(status);
00055         <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00056           <span class="keywordflow">continue</span>;
00057         <span class="keywordflow">else</span>
00058           <a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> = NULL;
00059       }
00060     
00061       <span class="comment">// Open log file</span>
00062       <span class="keywordflow">if</span> (<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> == NULL)
00063         <a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> = fopen(logName, <span class="stringliteral">"w"</span>);
00064       <span class="keywordflow">else</span> {
00065         status = <a class="code" href="namespacesource_identify.html#a38a26">STATUS_LOG_OPEN_FAILED</a>;
00066         <span class="keywordflow">continue</span>;
00067       }
00068       
00069       <span class="comment">// If log file is not opened then signal an error</span>
00070       <span class="keywordflow">if</span> (<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> == NULL) {
00071         status = <a class="code" href="namespacesource_identify.html#a38a26">STATUS_LOG_OPEN_FAILED</a>;
00072         <span class="keywordflow">continue</span>;
00073       }
00074 
00075       <span class="comment">// Store log task name</span>
00076       sprintf(<a class="code" href="namespacesource_identify.html#a6">gLogTaskName</a>, <span class="stringliteral">"%s"</span>, taskName);
00077 
00078     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00079 
00080     <span class="comment">// Return status</span>
00081     <span class="keywordflow">return</span> status;
00082 
00083 }
00084 
00085 
00086 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00087 <span class="comment">/*                                 LogClose                                   */</span>
00088 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00089 <span class="comment">/* Task: Finish task logging.                                                 */</span>
00090 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00091"></a><a class="code" href="namespacesource_identify.html#a35">00091</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> <a class="code" href="namespacesource_identify.html#a35">LogClose</a>(<a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00092 
00093     <span class="comment">// Declare (and initialise) variables</span>
00094 
00095     <span class="comment">// Main do-loop to fall through in case of an error</span>
00096     <span class="keywordflow">do</span> {
00097     
00098       <span class="comment">// Close log file</span>
00099       <span class="keywordflow">if</span> (<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> != NULL)
00100         fclose(<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a>);
00101       <span class="keywordflow">else</span> {
00102         status = <a class="code" href="namespacesource_identify.html#a38a27">STATUS_LOG_CLOSE_FAILED</a>;
00103         <span class="keywordflow">continue</span>;
00104       }
00105 
00106     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00107 
00108     <span class="comment">// Return status</span>
00109     <span class="keywordflow">return</span> status;
00110 
00111 }
00112 
00113 
00114 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00115 <span class="comment">/*                                    Log                                     */</span>
00116 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00117 <span class="comment">/* Task: Log message.                                                         */</span>
00118 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00119"></a><a class="code" href="namespacesource_identify.html#a36">00119</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37">MessageType</a> msgType, <span class="keyword">const</span> <span class="keywordtype">char</span> *msgFormat, ...) {
00120 
00121     <span class="comment">// Declare (and initialise) variables</span>
00122     <a class="code" href="namespacesource_identify.html#a38">Status</a>    status = <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>;
00123     va_list   vl;
00124     time_t    now;
00125     <span class="keyword">struct </span>tm timeStruct;
00126     <span class="keywordtype">char</span>      type[100];
00127 
00128     <span class="comment">// Main do-loop to fall through in case of an error</span>
00129     <span class="keywordflow">do</span> {
00130     
00131       <span class="comment">// If no log file has been opened then open one now</span>
00132       <span class="keywordflow">if</span> (<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a> == NULL) {
00133         status = <a class="code" href="namespacesource_identify.html#a34">LogInit</a>(<a class="code" href="_log_8h.html#a0">DEFAULT_LOG_FILENAME</a>, <a class="code" href="_log_8h.html#a1">DEFAULT_TASK_NAME</a>, status);
00134         <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00135           <span class="keywordflow">continue</span>;
00136       }
00137 
00138       <span class="comment">// Set message type</span>
00139       <span class="keywordflow">switch</span> (msgType) {
00140       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a8">Error_0</a>:
00141         sprintf(type, <span class="stringliteral">"Error_0"</span>);
00142         <span class="keywordflow">break</span>;
00143       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a9">Error_1</a>:
00144         sprintf(type, <span class="stringliteral">"Error_1"</span>);
00145         <span class="keywordflow">break</span>;
00146       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>:
00147         sprintf(type, <span class="stringliteral">"Error_2"</span>);
00148         <span class="keywordflow">break</span>;
00149       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a11">Error_3</a>:
00150         sprintf(type, <span class="stringliteral">"Error_3"</span>);
00151         <span class="keywordflow">break</span>;
00152       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a12">Warning_0</a>:
00153         sprintf(type, <span class="stringliteral">"Warn_0 "</span>);
00154         <span class="keywordflow">break</span>;
00155       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a13">Warning_1</a>:
00156         sprintf(type, <span class="stringliteral">"Warn_1 "</span>);
00157         <span class="keywordflow">break</span>;
00158       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>:
00159         sprintf(type, <span class="stringliteral">"Warn_2 "</span>);
00160         <span class="keywordflow">break</span>;
00161       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a15">Warning_3</a>:
00162         sprintf(type, <span class="stringliteral">"Warn_3 "</span>);
00163         <span class="keywordflow">break</span>;
00164       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a16">Alert_0</a>:
00165         sprintf(type, <span class="stringliteral">"Alert_0"</span>);
00166         <span class="keywordflow">break</span>;
00167       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a17">Alert_1</a>:
00168         sprintf(type, <span class="stringliteral">"Alert_1"</span>);
00169         <span class="keywordflow">break</span>;
00170       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a18">Alert_2</a>:
00171         sprintf(type, <span class="stringliteral">"Alert_2"</span>);
00172         <span class="keywordflow">break</span>;
00173       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a19">Alert_3</a>:
00174         sprintf(type, <span class="stringliteral">"Alert_3"</span>);
00175         <span class="keywordflow">break</span>;
00176       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>:
00177         sprintf(type, <span class="stringliteral">"Log_0  "</span>);
00178         <span class="keywordflow">break</span>;
00179       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a21">Log_1</a>:
00180         sprintf(type, <span class="stringliteral">"Log_1  "</span>);
00181         <span class="keywordflow">break</span>;
00182       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>:
00183         sprintf(type, <span class="stringliteral">"Log_2  "</span>);
00184         <span class="keywordflow">break</span>;
00185       <span class="keywordflow">case</span> <a class="code" href="namespacesource_identify.html#a37a23">Log_3</a>:
00186         sprintf(type, <span class="stringliteral">"Log_3  "</span>);
00187         <span class="keywordflow">break</span>;
00188       <span class="keywordflow">default</span>:
00189         sprintf(type, <span class="stringliteral">"Unknown"</span>);
00190         <span class="keywordflow">break</span>;
00191       }
00192       
00193       <span class="comment">// Get time</span>
00194       now = time(NULL);
00195 <span class="preprocessor">      #ifdef HAVE_GMTIME_R   </span>
00196 <span class="preprocessor"></span>        gmtime_r(&amp;now, &amp;timeStruct);
00197 <span class="preprocessor">      #else</span>
00198 <span class="preprocessor"></span>        memcpy(&amp;timeStruct, gmtime(&amp;now), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));      
00199 <span class="preprocessor">      #endif</span>
00200 <span class="preprocessor"></span>    
00201       <span class="comment">// Write message type, time and task name to log file</span>
00202       <span class="keywordflow">if</span> (fprintf(<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a>, <span class="stringliteral">"%s %04d-%02d-%02dT%02d:%02d:%02d %s: "</span>, 
00203                   type, 
00204                   timeStruct.tm_year + 1900,
00205                   timeStruct.tm_mon + 1,
00206                   timeStruct.tm_mday,
00207                   timeStruct.tm_hour,
00208                   timeStruct.tm_min,
00209                   timeStruct.tm_sec,
00210                   <a class="code" href="namespacesource_identify.html#a6">gLogTaskName</a>) &lt; 0) {
00211         status = <a class="code" href="namespacesource_identify.html#a38a28">STATUS_LOG_WRITE_FAILED</a>;
00212         <span class="keywordflow">continue</span>;
00213       }
00214 
00215       <span class="comment">// Write message to log file</span>
00216       va_start(vl, msgFormat);
00217       <span class="keywordflow">if</span> (vfprintf(<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a>, msgFormat, vl) &lt; 0) {
00218         status = <a class="code" href="namespacesource_identify.html#a38a28">STATUS_LOG_WRITE_FAILED</a>;
00219         <span class="keywordflow">continue</span>;
00220       }
00221       va_end(vl);
00222       
00223       <span class="comment">// Write &lt;CR&gt; to log file</span>
00224       <span class="keywordflow">if</span> (fprintf(<a class="code" href="namespacesource_identify.html#a7">gLogFilePtr</a>, <span class="stringliteral">"\n"</span>) != 1) {
00225         status = <a class="code" href="namespacesource_identify.html#a38a28">STATUS_LOG_WRITE_FAILED</a>;
00226         <span class="keywordflow">continue</span>;
00227       }
00228 
00229     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00230 
00231     <span class="comment">// Return status</span>
00232     <span class="keywordflow">return</span> status;
00233 
00234 }
00235 
00236 <span class="comment">/* Namespace ends ___________________________________________________________ */</span>
00237 }
</pre></div><hr><address style="align: right;"><small>Generated on Thu Jul 21 21:03:37 2005 for sourceIdentify by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
