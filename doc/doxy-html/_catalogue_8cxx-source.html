<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Catalogue.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Catalogue.cxx</h1><a href="_catalogue_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00002 <span class="comment">/*                               Catalogue.cxx                                */</span>
00003 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00004 <span class="comment">/* Task            : Catalogue interface file.                                */</span>
00005 <span class="comment">/* Author          : Jurgen Knodlseder CESR (C) (all rights reserved)         */</span>
00006 <span class="comment">/* Revision        : 1.1.0                                                    */</span>
00007 <span class="comment">/* Date of version : 21-Jul-2005                                              */</span>
00008 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00009 <span class="comment">/* History :                                                                  */</span>
00010 <span class="comment">/* 1.0.0  20-May-2005  first version                                          */</span>
00011 <span class="comment">/* 1.1.0  21-Jul-2005  add debug information                                  */</span>
00012 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00013 
00014 <span class="comment">/* Includes _________________________________________________________________ */</span>
00015 <span class="preprocessor">#include "<a class="code" href="source_identify_8h.html">sourceIdentify.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="_catalogue_8h.html">Catalogue.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="_log_8h.html">Log.h</a>"</span>
00018 <span class="preprocessor">#include "src/quantity.h"</span>
00019 
00020 
00021 <span class="comment">/* Namespace definition _____________________________________________________ */</span>
<a name="l00022"></a><a class="code" href="namespacesource_identify.html">00022</a> <span class="keyword">namespace </span>sourceIdentify {
00023 <span class="keyword">using</span> <span class="keyword">namespace </span>catalogAccess;
00024 
00025 
00026 <span class="comment">/* Type defintions __________________________________________________________ */</span>
00027 
00028 
00029 <span class="comment">/* Prototypes _______________________________________________________________ */</span>
00030 <span class="keywordtype">int</span> <a class="code" href="namespacesource_identify.html#a32">set_fits_col_format</a>(catalogAccess::Quantity *desc, std::string *format);
00031 <span class="keywordtype">int</span> <a class="code" href="namespacesource_identify.html#a33">fits_tform_binary</a>(<span class="keywordtype">int</span> typecode, <span class="keywordtype">long</span> repeat, <span class="keywordtype">long</span> width, 
00032                       std::string *format);
00033 
00034 
00035 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00036 <span class="comment">/*                             set_fits_col_format                            */</span>
00037 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00038 <span class="comment">/* Private function: set FITS column format from catalogue description        */</span>
00039 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00040"></a><a class="code" href="namespacesource_identify.html#a32">00040</a> <span class="keywordtype">int</span> <a class="code" href="namespacesource_identify.html#a32">set_fits_col_format</a>(catalogAccess::Quantity *desc, std::string *format) {
00041 
00042     <span class="comment">// Declare local variables</span>
00043     std::string            col_format;
00044     std::string::size_type len;
00045     std::string::size_type pos;
00046 
00047     <span class="comment">// Single loop for common exit point</span>
00048     <span class="keywordflow">do</span> {
00049 
00050       <span class="comment">// Set quantity format</span>
00051       <span class="keywordflow">switch</span> (desc-&gt;m_type) {
00052       <span class="keywordflow">case</span> Quantity::VECTOR:
00053         *format = <span class="stringliteral">"1E"</span>;
00054         <span class="keywordflow">break</span>;
00055       <span class="keywordflow">case</span> Quantity::NUM:
00056         *format = <span class="stringliteral">"1E"</span>;
00057         <span class="keywordflow">break</span>;
00058       <span class="keywordflow">case</span> Quantity::STRING:
00059         col_format = desc-&gt;m_format;
00060         len        = col_format.length();
00061         pos        = col_format.find(<span class="stringliteral">"A"</span>,0);
00062         <span class="keywordflow">if</span> (pos != std::string::npos) {
00063           <span class="keywordflow">if</span> (pos &lt; (len-1)) {
00064             pos++;
00065             len -= pos;
00066             *format = col_format.substr(pos,len) + <span class="stringliteral">"A"</span>;
00067           }
00068           <span class="keywordflow">else</span>
00069             *format = col_format;
00070         }
00071         <span class="keywordflow">else</span>
00072           *format = <span class="stringliteral">"10A"</span>;
00073         <span class="keywordflow">break</span>;
00074       <span class="keywordflow">default</span>:
00075         *format = <span class="stringliteral">"1E"</span>;
00076         <span class="keywordflow">break</span>;
00077       }
00078 
00079     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00080     
00081     <span class="comment">// Return</span>
00082     <span class="keywordflow">return</span> <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>;
00083 
00084 }
00085 
00086 
00087 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00088 <span class="comment">/*                               fits_tform_binary                            */</span>
00089 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00090 <span class="comment">/* Private function: set FITS column format from catalogue description        */</span>
00091 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00092"></a><a class="code" href="namespacesource_identify.html#a33">00092</a> <span class="keywordtype">int</span> <a class="code" href="namespacesource_identify.html#a33">fits_tform_binary</a>(<span class="keywordtype">int</span> typecode, <span class="keywordtype">long</span> repeat, <span class="keywordtype">long</span> width, 
00093                       std::string *format) {
00094 
00095     <span class="comment">// Declare local variables</span>
00096     <span class="keywordtype">char</span> add[256];
00097 
00098     <span class="comment">// Single loop for common exit point</span>
00099     <span class="keywordflow">do</span> {
00100 
00101       <span class="comment">// Set column format</span>
00102       <span class="keywordflow">switch</span> (typecode) {
00103       <span class="keywordflow">case</span> TBIT:
00104         *format = <span class="stringliteral">"X"</span>;
00105         <span class="keywordflow">break</span>;
00106       <span class="keywordflow">case</span> TBYTE:
00107         *format = <span class="stringliteral">"B"</span>;
00108         <span class="keywordflow">break</span>;
00109       <span class="keywordflow">case</span> TLOGICAL:
00110         *format = <span class="stringliteral">"L"</span>;
00111         <span class="keywordflow">break</span>;
00112       <span class="keywordflow">case</span> TSTRING:
00113         *format = <span class="stringliteral">"A"</span>;
00114         <span class="keywordflow">break</span>;
00115       <span class="keywordflow">case</span> TSHORT:
00116         *format = <span class="stringliteral">"I"</span>;
00117         <span class="keywordflow">break</span>;
00118       <span class="keywordflow">case</span> TINT32BIT:
00119         *format = <span class="stringliteral">"J"</span>;
00120         <span class="keywordflow">break</span>;
00121       <span class="keywordflow">case</span> TLONGLONG:
00122         *format = <span class="stringliteral">"K"</span>;
00123         <span class="keywordflow">break</span>;
00124       <span class="keywordflow">case</span> TFLOAT:
00125         *format = <span class="stringliteral">"E"</span>;
00126         <span class="keywordflow">break</span>;
00127       <span class="keywordflow">case</span> TDOUBLE:
00128         *format = <span class="stringliteral">"D"</span>;
00129         <span class="keywordflow">break</span>;
00130       <span class="keywordflow">case</span> TCOMPLEX:
00131         *format = <span class="stringliteral">"C"</span>;
00132         <span class="keywordflow">break</span>;
00133       <span class="keywordflow">case</span> TDBLCOMPLEX:
00134         *format = <span class="stringliteral">"M"</span>;
00135         <span class="keywordflow">break</span>;
00136       <span class="keywordflow">default</span>:
00137         format-&gt;clear();
00138         <span class="keywordflow">break</span>;
00139       }
00140 
00141       <span class="comment">// Add repeat string</span>
00142       <span class="keywordflow">if</span> (repeat &gt; 0) {
00143         sprintf(add, <span class="stringliteral">"%ld"</span>, repeat);
00144         *format = add + *format;
00145       }
00146 
00147       <span class="comment">// Add width string</span>
00148       <span class="keywordflow">if</span> (width &gt; 0) {
00149         sprintf(add, <span class="stringliteral">"%ld"</span>, width);
00150         *format = *format + add;
00151       }
00152 
00153     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00154     
00155     <span class="comment">// Return</span>
00156     <span class="keywordflow">return</span> <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>;
00157 
00158 }
00159 
00160 
00161 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00162 <span class="comment">/*                            Catalogue::init_memory                          */</span>
00163 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00164 <span class="comment">/* Private method: init memory                                                */</span>
00165 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00166"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c0">00166</a> <span class="keywordtype">void</span> Catalogue::init_memory(<span class="keywordtype">void</span>) {
00167 
00168     <span class="comment">// Declare local variables</span>
00169 
00170     <span class="comment">// Single loop for common exit point</span>
00171     <span class="keywordflow">do</span> {
00172 
00173       <span class="comment">// Intialise private members</span>
00174       <a class="code" href="classsource_identify_1_1_catalogue.html#o0">numSrc</a>     = 0;
00175       <a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a>     = 0;
00176       <a class="code" href="classsource_identify_1_1_catalogue.html#o2">maxCptLoad</a> = 10000;
00177       <a class="code" href="classsource_identify_1_1_catalogue.html#o3">fCptLoaded</a> = 0;
00178       <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>      = 0;
00179       <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>         = NULL;
00180 
00181     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00182     
00183     <span class="comment">// Return</span>
00184     <span class="keywordflow">return</span>;
00185 
00186 }
00187 
00188 
00189 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00190 <span class="comment">/*                             Catalogue::free_memory                         */</span>
00191 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00192 <span class="comment">/* Private method: free memory                                                */</span>
00193 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00194"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c1">00194</a> <span class="keywordtype">void</span> Catalogue::free_memory(<span class="keywordtype">void</span>) {
00195 
00196     <span class="comment">// Declare local variables</span>
00197 
00198     <span class="comment">// Single loop for common exit point</span>
00199     <span class="keywordflow">do</span> {
00200 
00201       <span class="comment">// Free temporary memory</span>
00202       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a> != NULL) <span class="keyword">delete</span> [] <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>;
00203 
00204       <span class="comment">// Initialise memory</span>
00205       <a class="code" href="classsource_identify_1_1_catalogue.html#c0">init_memory</a>();
00206 
00207     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00208     
00209     <span class="comment">// Return</span>
00210     <span class="keywordflow">return</span>;
00211 
00212 }
00213 
00214 
00215 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00216 <span class="comment">/*                       Catalogue::get_input_descriptor                      */</span>
00217 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00218 <span class="comment">/* Private method: get descriptor for input catalogue                         */</span>
00219 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00220"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c2">00220</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_input_descriptor(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, std::string catName, 
00221                                        catalogAccess::Catalog *cat,
00222                                        <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00223 
00224     <span class="comment">// Declare local variables</span>
00225     <span class="keywordtype">int</span> caterr;
00226 
00227     <span class="comment">// Debug mode: Entry</span>
00228     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00229       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_input_descriptor"</span>);
00230 
00231     <span class="comment">// Single loop for common exit point</span>
00232     <span class="keywordflow">do</span> {
00233     
00234       <span class="comment">// First interpret the input string as filename and load the catalogue</span>
00235       <span class="comment">// from the file. If this fails then interpret input string as</span>
00236       <span class="comment">// catalogue name and load from WEB.</span>
00237       caterr = cat-&gt;importDescription(catName);
00238       <span class="keywordflow">if</span> (caterr &lt; 0) {
00239         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00240           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">"%d : Unable to load catalogue '%s' descriptor from"</span>
00241               <span class="stringliteral">" file."</span>, caterr, catName.c_str());
00242         caterr = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.importDescriptionWeb(catName);
00243         <span class="keywordflow">if</span> (caterr &lt; 0) {
00244           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00245             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load catalogue '%s' descriptor from"</span>
00246                 <span class="stringliteral">" file or web."</span>, caterr, catName.c_str());
00247           status = <a class="code" href="namespacesource_identify.html#a38a30">STATUS_CAT_NOT_FOUND</a>;
00248           <span class="keywordflow">continue</span>;
00249         }
00250         <span class="keywordflow">else</span> {
00251           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00252             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Loaded catalogue '%s' descriptor from web."</span>, 
00253                 catName.c_str());
00254         }
00255       }
00256       <span class="keywordflow">else</span> {
00257         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00258           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Loaded catalogue '%s' descriptor from file."</span>, 
00259               catName.c_str());
00260       }
00261       
00262       <span class="comment">// Debug mode: dump catalogue descriptor</span>
00263       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>()) {
00264         status = <a class="code" href="classsource_identify_1_1_catalogue.html#c13">dump_descriptor</a>(cat, status);
00265         <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00266           <span class="keywordflow">continue</span>;
00267       }
00268     
00269     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00270 
00271     <span class="comment">// Debug mode: Entry</span>
00272     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00273       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_input_descriptor (status=%d)"</span>, 
00274           status);
00275     
00276     <span class="comment">// Return status</span>
00277     <span class="keywordflow">return</span> status;
00278 
00279 }
00280 
00281 
00282 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00283 <span class="comment">/*                        Catalogue::get_input_catalogue                      */</span>
00284 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00285 <span class="comment">/* Private method: get data for input catalogue                               */</span>
00286 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00287"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c3">00287</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_input_catalogue(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, std::string catName, 
00288                                       catalogAccess::Catalog *cat,
00289                                       <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00290 
00291     <span class="comment">// Declare local variables</span>
00292     <span class="keywordtype">int</span> caterr;
00293 
00294     <span class="comment">// Debug mode: Entry</span>
00295     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00296       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_input_catalogue"</span>);
00297 
00298     <span class="comment">// Single loop for common exit point</span>
00299     <span class="keywordflow">do</span> {
00300 
00301       <span class="comment">// First interpret the input string as filename and load the catalogue</span>
00302       <span class="comment">// from the file. If this fails then interpret input string as</span>
00303       <span class="comment">// catalogue name and load from WEB.</span>
00304       caterr = cat-&gt;import(catName);
00305       <span class="keywordflow">if</span> (caterr &lt; 0) {
00306         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00307           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">"%d : Unable to load catalogue '%s' from file."</span>,
00308               caterr, catName.c_str());
00309         caterr = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.importWeb(catName);
00310         <span class="keywordflow">if</span> (caterr &lt; 0) {
00311           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00312             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load catalogue '%s' from file or web."</span>,
00313                 caterr, catName.c_str());
00314           status = <a class="code" href="namespacesource_identify.html#a38a30">STATUS_CAT_NOT_FOUND</a>;
00315           <span class="keywordflow">continue</span>;
00316         }
00317         <span class="keywordflow">else</span> {
00318           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00319             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Loaded catalogue '%s' from web."</span>, catName.c_str());
00320         }
00321       }
00322       <span class="keywordflow">else</span> {
00323         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00324           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Loaded catalogue '%s' from file."</span>, catName.c_str());
00325       }
00326       
00327     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00328 
00329     <span class="comment">// Debug mode: Entry</span>
00330     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00331       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_input_catalogue (status=%d)"</span>, 
00332           status);
00333     
00334     <span class="comment">// Return status</span>
00335     <span class="keywordflow">return</span> status;
00336 
00337 }
00338 
00339 
00340 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00341 <span class="comment">/*                    Catalogue::get_counterpart_candidates                   */</span>
00342 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00343 <span class="comment">/* Private method: get  counterpart candidates for source 'iSrc'              */</span>
00344 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00345"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c4">00345</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_counterpart_candidates(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <span class="keywordtype">long</span> iSrc, 
00346                                              <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00347 
00348     <span class="comment">// Declare local variables</span>
00349     <span class="keywordtype">double</span>      ra;
00350     <span class="keywordtype">double</span>      dec;
00351     <span class="keywordtype">double</span>      pos_err;
00352     std::string src_name;
00353     std::string obj_name;
00354 
00355     <span class="comment">// Debug mode: Entry</span>
00356     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00357       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_counterpart_candidates"</span>);
00358 
00359     <span class="comment">// Single loop for common exit point</span>
00360     <span class="keywordflow">do</span> {
00361 
00362       <span class="comment">// Determine the name of the generic quantity "object name"</span>
00363       obj_name = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getNameObjName();
00364 
00365       <span class="comment">// Get source coordinates</span>
00366       <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.ra_deg(iSrc,  &amp;ra);
00367       <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.dec_deg(iSrc, &amp;dec);
00368       <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.posError_deg(iSrc, &amp;pos_err);
00369       <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getSValue(obj_name, iSrc, &amp;src_name);
00370 
00371       <span class="comment">// Optionally dump source information</span>
00372       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a6">logExplicit</a>()) {
00373         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">""</span>);
00374         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Source %5d .....................: %s"</span>
00375             <span class="stringliteral">" (%8.3f,%8.3f) +/- %8.3f"</span>,
00376             iSrc, src_name.c_str(), ra, dec, pos_err);
00377       }
00378         
00379       <span class="comment">// Get counterparts near the source position</span>
00380       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c5">get_counterparts</a>(par, &amp;ra, &amp;dec, &amp;pos_err, status);
00381       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00382         <span class="keywordflow">continue</span>;
00383 
00384       <span class="comment">// Assign probability for each counterpart</span>
00385       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c6">get_probability</a>(par, iSrc, status);
00386       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00387         <span class="keywordflow">continue</span>;
00388 
00389       <span class="comment">// Add all counterpart candidates to output catalogue</span>
00390       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c9">add_counterpart_candidates</a>(par, iSrc, status);
00391       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00392         <span class="keywordflow">continue</span>;
00393 
00394       <span class="comment">// Optionally dump counterpart candidats</span>
00395       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a6">logExplicit</a>())
00396         <a class="code" href="classsource_identify_1_1_catalogue.html#c14">dump_counterpart_candidates</a>(par, status);
00397 
00398     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00399 
00400     <span class="comment">// Debug mode: Entry</span>
00401     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00402       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_counterpart_candidates (status=%d)"</span>, 
00403           status);
00404     
00405     <span class="comment">// Return status</span>
00406     <span class="keywordflow">return</span> status;
00407 
00408 }
00409 
00410 
00411 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00412 <span class="comment">/*                         Catalogue::get_counterparts                        */</span>
00413 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00414 <span class="comment">/* Private method: get data from counterpart catalogue                        */</span>
00415 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00416 <span class="comment">/*                  Filter step of counterpart identification                 */</span>
00417 <span class="comment">/*                                                                            */</span>
00418 <span class="comment">/* If the counterpart catalogue is big we load here only the part of the      */</span>
00419 <span class="comment">/* catalogue that spatially overlaps with the specified source position.      */</span>
00420 <span class="comment">/* Otherwise we load the entire catalogue (only on the first call).           */</span>
00421 <span class="comment">/* For all counterpart candidates that were loaded we calculate the angular   */</span>
00422 <span class="comment">/* separation to the source of interest and keep only those candidates that   */</span>
00423 <span class="comment">/* are spatially sufficient close to the source.                              */</span>
00424 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00425"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c5">00425</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_counterparts(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <span class="keywordtype">double</span> *ra, <span class="keywordtype">double</span> *dec,
00426                                    <span class="keywordtype">double</span> *pos_err, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00427 
00428     <span class="comment">// Declare local variables</span>
00429     <span class="keywordtype">long</span>   iCpt;
00430     <span class="keywordtype">long</span>   numNoPos;
00431     <span class="keywordtype">long</span>   numNoError;
00432     <span class="keywordtype">double</span> src_dec_sin;
00433     <span class="keywordtype">double</span> src_dec_cos;
00434     <span class="keywordtype">double</span> cpt_ra;
00435     <span class="keywordtype">double</span> cpt_dec;
00436     <span class="keywordtype">double</span> cpt_error;
00437     <span class="keywordtype">double</span> cpt_dec_sin;
00438     <span class="keywordtype">double</span> cpt_dec_cos;
00439     <span class="keywordtype">double</span> angsep;
00440 
00441     <span class="comment">// Debug mode: Entry</span>
00442     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00443       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_counterparts"</span>);
00444 
00445     <span class="comment">// Single loop for common exit point</span>
00446     <span class="keywordflow">do</span> {
00447 
00448       <span class="comment">// Reset statistics</span>
00449       <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>      = 0;
00450       numNoPos   = 0;
00451       numNoError = 0;
00452 
00453       <span class="comment">// Calculate sin and cos of source latitude</span>
00454       src_dec_sin = sin(*dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00455       src_dec_cos = cos(*dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00456     
00457       <span class="comment">// If the counterpart catalogue is big then load only sources from a</span>
00458       <span class="comment">// region around the specified position ...</span>
00459       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a> &gt; <a class="code" href="classsource_identify_1_1_catalogue.html#o2">maxCptLoad</a>) {
00460       }
00461       
00462       <span class="comment">// ... otherwise load the entire counterpart catalogue</span>
00463       <span class="keywordflow">else</span> {
00464 
00465         <span class="comment">// Load only if noy yet done ...</span>
00466         <span class="keywordflow">if</span> (!<a class="code" href="classsource_identify_1_1_catalogue.html#o3">fCptLoaded</a>) {
00467 
00468           <span class="comment">// Load counterpart catalogue</span>
00469           status = <a class="code" href="classsource_identify_1_1_catalogue.html#c3">get_input_catalogue</a>(par, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o1">m_cptCatName</a>, &amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>, status);
00470           <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
00471             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00472               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load counterpart catalogue '%s'"</span>
00473                   <span class="stringliteral">" data."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o1">m_cptCatName</a>.c_str());
00474             <span class="keywordflow">continue</span>;
00475           }
00476           <span class="keywordflow">else</span> {
00477             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00478               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Counterpart catalogue loaded."</span>);
00479           }
00480 
00481           <span class="comment">// Determine the number of sources in counterpart catalogue. Stop if</span>
00482           <span class="comment">// the catalogue is empty</span>
00483           <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getNumRows(&amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a>);
00484           <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a> &lt; 1) {
00485             status = <a class="code" href="namespacesource_identify.html#a38a31">STATUS_CAT_EMPTY</a>;
00486             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00487               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Counterpart catalogue is empty. Stop."</span>, 
00488                   (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00489             <span class="keywordflow">continue</span>;
00490           }
00491           <span class="keywordflow">else</span> {
00492             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
00493               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Counterpart catalogue contains %d sources."</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a>);
00494           }
00495           
00496           <span class="comment">// Allocate memory for counterpart candidate search</span>
00497           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a> = <span class="keyword">new</span> <a class="code" href="structsource_identify_1_1_c_c_element.html">CCElement</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a>];
00498           <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a> == NULL) {
00499             status = <a class="code" href="namespacesource_identify.html#a38a25">STATUS_MEM_ALLOC</a>;
00500             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00501               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Memory allocation failure."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00502             <span class="keywordflow">continue</span>;
00503           }
00504  
00505           <span class="comment">// Bookkeep catalogue loading</span>
00506           <a class="code" href="classsource_identify_1_1_catalogue.html#o3">fCptLoaded</a> = 1;
00507           
00508         } <span class="comment">// endif: catalogue was not yet loaded</span>
00509       } <span class="comment">// endelse: entire catalogue requested</span>
00510 
00511       <span class="comment">// Loop over counterparts</span>
00512       <span class="keywordflow">for</span> (iCpt = 0; iCpt &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o1">numCpt</a>; iCpt++) {
00513 
00514         <span class="comment">// Extract counterpart coordinates. Skip if no coordinates were found</span>
00515         <span class="keywordflow">if</span> ((<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.ra_deg(iCpt,  &amp;cpt_ra)  != IS_OK) ||
00516             (<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.dec_deg(iCpt, &amp;cpt_dec) != IS_OK)) {
00517           numNoPos++;
00518           <span class="keywordflow">continue</span>;
00519         }
00520 
00521         <span class="comment">// Extract counterpart positional uncertainty. Log in no uncertainty</span>
00522         <span class="comment">// was found</span>
00523         <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.posError_deg(iCpt, &amp;cpt_error) != IS_OK) {
00524           numNoError++;
00525         }
00526 
00527         <span class="comment">// Calculate angular separation in degrees</span>
00528         cpt_dec_sin = sin(cpt_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00529         cpt_dec_cos = cos(cpt_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00530         angsep      = acos(src_dec_sin * cpt_dec_sin +
00531                            src_dec_cos * cpt_dec_cos * 
00532                            cos((*ra - cpt_ra)*<a class="code" href="namespacesource_identify.html#a4">deg2rad</a>)) * <a class="code" href="namespacesource_identify.html#a5">rad2deg</a>;
00533 
00534         <span class="comment">// Keep only candidates with sufficiently small angular separation</span>
00535         <span class="comment">// (DUMMY)</span>
00536         <span class="keywordflow">if</span> (angsep &lt; 20.0) {
00537           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].id          = <span class="stringliteral">"NULL"</span>;
00538           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].pos_eq_ra   = 0.0;
00539           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].pos_eq_dec  = 0.0;
00540           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].pos_err_maj = 0.0;
00541           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].pos_err_min = 0.0;
00542           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].pos_err_ang = 0.0;
00543           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].prob        = 0.0;
00544           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].index       = iCpt;
00545           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].angsep      = 0.0;
00546           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>].prob_angsep = 0.0;
00547           <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>++;
00548         }
00549         
00550       } <span class="comment">// endfor: looped over counterparts</span>
00551 
00552       <span class="comment">// Optionally dump counterpart filter statistics</span>
00553       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a6">logExplicit</a>()) {
00554         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Filter step candidates ..........: %d"</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>);
00555         <span class="keywordflow">if</span> (numNoPos &gt; 0)
00556           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">"              no positions ........: %d"</span>, numNoPos);
00557         <span class="keywordflow">if</span> (numNoError &gt; 0)
00558           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">"              no errors ...........: %d"</span>, numNoError);
00559       }
00560 
00561     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00562 
00563     <span class="comment">// Debug mode: Entry</span>
00564     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00565       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_counterparts (status=%d)"</span>, 
00566           status);
00567     
00568     <span class="comment">// Return status</span>
00569     <span class="keywordflow">return</span> status;
00570 
00571 }
00572 
00573 
00574 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00575 <span class="comment">/*                          Catalogue::get_probability                        */</span>
00576 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00577 <span class="comment">/* Private method: calculate the counterpart probability                      */</span>
00578 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00579 <span class="comment">/*                  Refine step of counterpart identification                 */</span>
00580 <span class="comment">/*                                                                            */</span>
00581 <span class="comment">/* Calculates the counterpart probability, sorts all counterpart candidates   */</span>
00582 <span class="comment">/* by decreasing probability and eliminates all candidtates with a too low    */</span>
00583 <span class="comment">/* probability.                                                               */</span>
00584 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00585"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c6">00585</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_probability(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <span class="keywordtype">long</span> iSrc, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00586 
00587     <span class="comment">// Declare local variables</span>
00588     <span class="keywordtype">long</span> iCC;
00589     <span class="keywordtype">long</span> numUseCC;
00590     <span class="keywordtype">char</span> cid[<a class="code" href="_catalogue_8h.html#a0">OUTCAT_MAX_STRING_LEN</a>];
00591 
00592     <span class="comment">// Debug mode: Entry</span>
00593     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00594       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_probability"</span>);
00595 
00596     <span class="comment">// Single loop for common exit point</span>
00597     <span class="keywordflow">do</span> {
00598     
00599       <span class="comment">// Fall through in case of an error</span>
00600       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00601         <span class="keywordflow">continue</span>;
00602         
00603       <span class="comment">// Fall through if there are no counterpart candidates</span>
00604       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1)
00605         <span class="keywordflow">continue</span>;
00606 
00607       <span class="comment">// Determine counterpart probabilities based on angular separation</span>
00608       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c7">get_probability_angsep</a>(par, iSrc, status);
00609       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
00610         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00611           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to determine counterpart probabilities"</span>
00612               <span class="stringliteral">" based on angular separation."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00613         <span class="keywordflow">continue</span>;
00614       }
00615     
00616       <span class="comment">// Assign the counterpart probabilities</span>
00617       <span class="comment">// DUMMY: we only use the probability based on angular separation</span>
00618       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++)
00619         <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a> = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m9">prob_angsep</a>;              
00620 
00621       <span class="comment">// Sort counterpart candidates by decreasing probability</span>
00622       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c12">cc_sort</a>(par, status);
00623       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
00624         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00625           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to sort counterpart candidates."</span>, 
00626               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00627         <span class="keywordflow">continue</span>;
00628       }
00629 
00630       <span class="comment">// Determine the number of counterpart candidates above the probability </span>
00631       <span class="comment">// threshold</span>
00632       numUseCC = 0;
00633       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++) {
00634         <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a> &gt;= par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o9">m_probThres</a>)
00635           numUseCC++;
00636         <span class="keywordflow">else</span>
00637           <span class="keywordflow">break</span>;
00638       }
00639 
00640       <span class="comment">// Apply the maximum number of counterpart threshold</span>
00641       <span class="keywordflow">if</span> (numUseCC &gt; par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o10">m_maxNumCtp</a>)
00642         numUseCC = par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o10">m_maxNumCtp</a>;
00643 
00644       <span class="comment">// Eliminate counterpart candidates below threshold. Fall through if no </span>
00645       <span class="comment">// counterparts are left</span>
00646       <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> = numUseCC;
00647       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1) {
00648         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a6">logExplicit</a>())
00649           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Refine step candidates ..........: no"</span>);
00650         <span class="keywordflow">continue</span>;
00651       }
00652 
00653       <span class="comment">// Set unique counterpart candidate identifier</span>
00654       <span class="comment">// DUMMY: Build string from indices</span>
00655       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++) {
00656         sprintf(cid, <span class="stringliteral">"CC_%5.5ld_%5.5ld"</span>, iSrc+1, iCC+1);
00657         <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m0">id</a> = cid;
00658       }
00659 
00660       <span class="comment">// Optionally dump counterpart refine statistics</span>
00661       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a6">logExplicit</a>()) {
00662         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Refine step candidates ..........: %d"</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>);
00663       }
00664     
00665     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00666 
00667     <span class="comment">// Debug mode: Entry</span>
00668     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00669       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_probability (status=%d)"</span>, 
00670           status);
00671     
00672     <span class="comment">// Return status</span>
00673     <span class="keywordflow">return</span> status;
00674 
00675 }
00676 
00677 
00678 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00679 <span class="comment">/*                       Catalogue::get_probability_angsep                    */</span>
00680 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00681 <span class="comment">/* Private method: calculate the counterpart probability based on angular     */</span>
00682 <span class="comment">/*                 separation for all candidates                              */</span>
00683 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00684 <span class="comment">/* TBW                                                                        */</span>
00685 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00686 <span class="comment">/* The following members of the counterpart candidates are set:               */</span>
00687 <span class="comment">/* pos_eq_ra    Right Ascension of counterpart candidate (deg)                */</span>
00688 <span class="comment">/* pos_eq_dec   Declination of counterpart candidate (deg)                    */</span>
00689 <span class="comment">/* pos_err_maj  Uncertainty ellipse major axis (deg)                          */</span>
00690 <span class="comment">/* pos_err_min  Uncertainty ellipse minor axis (deg)                          */</span>
00691 <span class="comment">/* pos_err_ang  Uncertainty ellipse positron angle (deg)                      */</span>
00692 <span class="comment">/* angsep       Angular separation of counterpart candidate from source       */</span>
00693 <span class="comment">/* prob_angsep  Probability of counterpart candidate based on position        */</span>
00694 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00695"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c7">00695</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::get_probability_angsep(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <span class="keywordtype">long</span> iSrc, 
00696                                          <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00697 
00698     <span class="comment">// Declare local variables</span>
00699     <span class="keywordtype">long</span>   iCC;
00700     <span class="keywordtype">long</span>   iCpt;
00701     <span class="keywordtype">double</span> src_ra;
00702     <span class="keywordtype">double</span> src_dec;
00703     <span class="keywordtype">double</span> src_err_maj;
00704     <span class="keywordtype">double</span> src_err_min;
00705     <span class="keywordtype">double</span> src_err_ang;
00706     <span class="keywordtype">double</span> src_dec_sin;
00707     <span class="keywordtype">double</span> src_dec_cos;
00708     <span class="keywordtype">double</span> cpt_ra;
00709     <span class="keywordtype">double</span> cpt_dec;
00710     <span class="keywordtype">double</span> cpt_err_maj;
00711     <span class="keywordtype">double</span> cpt_err_min;
00712     <span class="keywordtype">double</span> cpt_err_ang;
00713     <span class="keywordtype">double</span> cpt_dec_sin;
00714     <span class="keywordtype">double</span> cpt_dec_cos;
00715 
00716     <span class="comment">// Debug mode: Entry</span>
00717     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00718       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::get_probability_angsep"</span>);
00719 
00720     <span class="comment">// Single loop for common exit point</span>
00721     <span class="keywordflow">do</span> {
00722     
00723       <span class="comment">// Fall through in case of an error</span>
00724       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00725         <span class="keywordflow">continue</span>;
00726         
00727       <span class="comment">// Fall through if there are no counterpart candidates</span>
00728       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1)
00729         <span class="keywordflow">continue</span>;
00730 
00731       <span class="comment">// Get position and error ellipse for source. Fall through if information</span>
00732       <span class="comment">// is not available</span>
00733       src_err_ang = 0.0;
00734       <span class="keywordflow">if</span> ((<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.ra_deg(iSrc, &amp;src_ra)            != IS_OK) ||
00735           (<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.dec_deg(iSrc, &amp;src_dec)          != IS_OK) ||
00736           (<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.posError_deg(iSrc, &amp;src_err_maj) != IS_OK) ||
00737           (<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.posError_deg(iSrc, &amp;src_err_min) != IS_OK))
00738         <span class="keywordflow">continue</span>;
00739 
00740       <span class="comment">// Calculate sin and cos of source declination</span>
00741       src_dec_sin = sin(src_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00742       src_dec_cos = cos(src_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00743     
00744       <span class="comment">// Loop over counterpart candidates</span>
00745       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++) {
00746 
00747         <span class="comment">// Get index of candidate in counterpart catalogue</span>
00748         iCpt = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m7">index</a>;
00749 
00750         <span class="comment">// Get position for counterpart candidate. Fall through if position is </span>
00751         <span class="comment">// not available</span>
00752         <span class="keywordflow">if</span> ((<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.ra_deg(iCpt, &amp;cpt_ra)   != IS_OK) ||
00753             (<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.dec_deg(iCpt, &amp;cpt_dec) != IS_OK))
00754           <span class="keywordflow">continue</span>;
00755 
00756         <span class="comment">// Get error ellipse for counterpart candidate. Assume no error if error</span>
00757         <span class="comment">// ellipse is not available</span>
00758         cpt_err_ang = 0.0;
00759         <span class="keywordflow">if</span> ((<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.posError_deg(iCpt, &amp;cpt_err_maj) != IS_OK) ||
00760             (<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.posError_deg(iCpt, &amp;cpt_err_min) != IS_OK)) {
00761           cpt_err_maj = 0.0;
00762           cpt_err_min = 0.0;
00763         }
00764 <span class="comment">/*</span>
00765 <span class="comment">        if ((cpt.ra_deg(iCpt, &amp;cpt_ra)            != IS_OK) ||</span>
00766 <span class="comment">            (cpt.dec_deg(iCpt, &amp;cpt_dec)          != IS_OK) ||</span>
00767 <span class="comment">            (cpt.posError_deg(iCpt, &amp;cpt_err_maj) != IS_OK) ||</span>
00768 <span class="comment">            (cpt.posError_deg(iCpt, &amp;cpt_err_min) != IS_OK))</span>
00769 <span class="comment">          continue;</span>
00770 <span class="comment">*/</span>
00771         <span class="comment">// Calculate angular separation between source and counterpart in</span>
00772         <span class="comment">// degrees</span>
00773         cpt_dec_sin    = sin(cpt_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00774         cpt_dec_cos    = cos(cpt_dec * <a class="code" href="namespacesource_identify.html#a4">deg2rad</a>);
00775         <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m8">angsep</a> = acos(src_dec_sin * cpt_dec_sin +
00776                               src_dec_cos * cpt_dec_cos * 
00777                               cos((src_ra - cpt_ra)*<a class="code" href="namespacesource_identify.html#a4">deg2rad</a>)) * <a class="code" href="namespacesource_identify.html#a5">rad2deg</a>;
00778 
00779         <span class="comment">// Calculate counterpart probability from angular separation</span>
00780         <span class="comment">// DUMMY: we use an exponential law for the probability</span>
00781         <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m9">prob_angsep</a> = 
00782           exp(-<a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].angsep / sqrt(cpt_err_maj*cpt_err_maj + 
00783                                      src_err_maj*src_err_maj));
00784 
00785         <span class="comment">// Assign position and error ellipse</span>
00786         <span class="comment">// DUMMY: we assign the position and error ellipse of the partner</span>
00787         <span class="comment">//        that has the smaller positional uncertainty</span>
00788         <span class="keywordflow">if</span> (cpt_err_maj &lt; src_err_maj) {
00789           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m1">pos_eq_ra</a>   = cpt_ra;
00790           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m2">pos_eq_dec</a>  = cpt_dec;
00791           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m3">pos_err_maj</a> = cpt_err_maj;
00792           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m4">pos_err_min</a> = cpt_err_min;
00793           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m5">pos_err_ang</a> = cpt_err_ang;
00794         }
00795         <span class="keywordflow">else</span> {
00796           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m1">pos_eq_ra</a>   = src_ra;
00797           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m2">pos_eq_dec</a>  = src_dec;
00798           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m3">pos_err_maj</a> = src_err_maj;
00799           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m4">pos_err_min</a> = src_err_min;
00800           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m5">pos_err_ang</a> = src_err_ang;
00801         }
00802               
00803       } <span class="comment">// endfor: looped over counterpart candidates</span>
00804 
00805     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
00806 
00807     <span class="comment">// Debug mode: Entry</span>
00808     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00809       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::get_probability_angsep (status=%d)"</span>, 
00810           status);
00811     
00812     <span class="comment">// Return status</span>
00813     <span class="keywordflow">return</span> status;
00814 
00815 }
00816 
00817 
00818 <span class="comment">/*----------------------------------------------------------------------------*/</span>
00819 <span class="comment">/*                      Catalogue::create_output_catalogue                    */</span>
00820 <span class="comment">/* -------------------------------------------------------------------------- */</span>
00821 <span class="comment">/* Private method: create an empty FITS output catalogue                      */</span>
00822 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00823"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c8">00823</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::create_output_catalogue(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
00824 
00825     <span class="comment">// Declare local variables</span>
00826     <span class="keywordtype">int</span>                                    fstatus;
00827     <span class="keywordtype">int</span>                                    col;
00828     <span class="keywordtype">int</span>                                    num_col;
00829     <span class="keywordtype">long</span>                                   iQty;
00830     <span class="keywordtype">long</span>                                   numQty;
00831     std::string                            form;
00832     std::vector&lt;std::string&gt;               qtyNames;
00833     std::vector&lt;std::string&gt;               qtyUnits;
00834     std::vector&lt;catalogAccess::Quantity&gt;   qtyDesc;
00835     <span class="keywordtype">char</span>                                 **ttype;
00836     <span class="keywordtype">char</span>                                 **tform;
00837     <span class="keywordtype">char</span>                                 **tunit;
00838 
00839     <span class="comment">// Debug mode: Entry</span>
00840     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
00841       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::create_output_catalogue"</span>);
00842 
00843     <span class="comment">// Initialise temporary memory pointers</span>
00844     ttype = NULL;
00845     tform = NULL;
00846     tunit = NULL;
00847 
00848     <span class="comment">// Initialise FITSIO status</span>
00849     fstatus = (int)status;
00850 
00851     <span class="comment">// Single loop for common exit point</span>
00852     <span class="keywordflow">do</span> {
00853     
00854       <span class="comment">// Fall through in case of an error</span>
00855       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00856         <span class="keywordflow">continue</span>;
00857 
00858       <span class="comment">// If clobber=1 we make sure that the output catalogue does not yet exist</span>
00859       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o12">m_clobber</a>)
00860         remove(par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o2">m_outCatName</a>.c_str());
00861         
00862       <span class="comment">// Create empty FITS file.</span>
00863       fstatus = fits_create_file(&amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o2">m_outCatName</a>.c_str(), &amp;fstatus);
00864       <span class="keywordflow">if</span> (fstatus != 0) {
00865         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00866           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to create output catalogue '%s'."</span>, 
00867               fstatus, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o2">m_outCatName</a>.c_str());
00868         <span class="keywordflow">continue</span>;
00869       }
00870 
00871       <span class="comment">// Initialise column index to the OUTCAT_NUM_GENERIC generic columns</span>
00872       num_col     = <a class="code" href="_catalogue_8h.html#a3">OUTCAT_NUM_GENERIC</a>;
00873       <a class="code" href="classsource_identify_1_1_catalogue.html#o9">num_src_Qty</a> = 0;
00874       <a class="code" href="classsource_identify_1_1_catalogue.html#o14">num_cpt_Qty</a> = 0;
00875 
00876       <span class="comment">// Add source catalogue columns</span>
00877       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getQuantityNames(&amp;qtyNames);
00878       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getQuantityUnits(&amp;qtyUnits);
00879       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getQuantityDescription(&amp;qtyDesc);
00880       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; numQty; iQty++) {
00881         <span class="keywordflow">if</span> ((par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o3">m_srcCatQty</a>.find(<span class="stringliteral">"*"</span>, 0)            != std::string::npos) ||
00882             (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o3">m_srcCatQty</a>.find(qtyNames[iQty], 0) != std::string::npos)) {
00883 
00884           <span class="comment">// Increment number of source quantities and FITS file columns</span>
00885           <a class="code" href="classsource_identify_1_1_catalogue.html#o9">num_src_Qty</a>++;
00886           num_col++;
00887 
00888           <span class="comment">// Set quantity FITS column format</span>
00889           <a class="code" href="namespacesource_identify.html#a32">set_fits_col_format</a>(&amp;qtyDesc[iQty], &amp;form);
00890         
00891           <span class="comment">// Add quantity information to source quantity string</span>
00892           <a class="code" href="classsource_identify_1_1_catalogue.html#o11">src_Qty_ttype</a>.push_back(qtyNames[iQty]);
00893           <a class="code" href="classsource_identify_1_1_catalogue.html#o12">src_Qty_tform</a>.push_back(form);
00894           <a class="code" href="classsource_identify_1_1_catalogue.html#o13">src_Qty_tunit</a>.push_back(qtyUnits[iQty]);
00895         }
00896       }
00897 
00898       <span class="comment">// Add counterpart catalogue columns</span>
00899       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getQuantityNames(&amp;qtyNames);
00900       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getQuantityUnits(&amp;qtyUnits);
00901       numQty = <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getQuantityDescription(&amp;qtyDesc);
00902       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; numQty; iQty++) {
00903         <span class="keywordflow">if</span> ((par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o4">m_cptCatQty</a>.find(<span class="stringliteral">"*"</span>, 0)            != std::string::npos) ||
00904             (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o4">m_cptCatQty</a>.find(qtyNames[iQty], 0) != std::string::npos)) {
00905 
00906           <span class="comment">// Increment number of source quantities and FITS file columns</span>
00907           <a class="code" href="classsource_identify_1_1_catalogue.html#o14">num_cpt_Qty</a>++;
00908           num_col++;
00909 
00910           <span class="comment">// Set quantity FITS column format</span>
00911           <a class="code" href="namespacesource_identify.html#a32">set_fits_col_format</a>(&amp;qtyDesc[iQty], &amp;form);
00912         
00913           <span class="comment">// Add quantity information to source quantity string</span>
00914           <a class="code" href="classsource_identify_1_1_catalogue.html#o16">cpt_Qty_ttype</a>.push_back(qtyNames[iQty]);
00915           <a class="code" href="classsource_identify_1_1_catalogue.html#o17">cpt_Qty_tform</a>.push_back(form);
00916           <a class="code" href="classsource_identify_1_1_catalogue.html#o18">cpt_Qty_tunit</a>.push_back(qtyUnits[iQty]);
00917         }
00918       }
00919 
00920       <span class="comment">// Allocate temporary memory to hold column information</span>
00921       ttype = <span class="keyword">new</span> (<span class="keywordtype">char</span>*)[num_col];
00922       tform = <span class="keyword">new</span> (<span class="keywordtype">char</span>*)[num_col];
00923       tunit = <span class="keyword">new</span> (<span class="keywordtype">char</span>*)[num_col];
00924       <span class="keywordflow">if</span> (ttype == NULL ||
00925           tform == NULL ||
00926           tunit == NULL) {
00927         status = <a class="code" href="namespacesource_identify.html#a38a25">STATUS_MEM_ALLOC</a>;
00928         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00929           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Memory allocation failure."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00930         <span class="keywordflow">continue</span>;
00931       }
00932       <span class="keywordflow">for</span> (col = 0; col &lt; num_col; col++) {
00933         ttype[col] = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="_catalogue_8h.html#a1">OUTCAT_MAX_KEY_LEN</a>];
00934         tform[col] = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="_catalogue_8h.html#a1">OUTCAT_MAX_KEY_LEN</a>];
00935         tunit[col] = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="_catalogue_8h.html#a1">OUTCAT_MAX_KEY_LEN</a>];
00936         <span class="keywordflow">if</span> (ttype[col] == NULL ||
00937             tform[col] == NULL ||
00938             tunit[col] == NULL) {
00939           status = <a class="code" href="namespacesource_identify.html#a38a25">STATUS_MEM_ALLOC</a>;
00940           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
00941             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Memory allocation failure."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
00942           <span class="keywordflow">break</span>;
00943         }
00944         sprintf(ttype[col], <span class="stringliteral">""</span>);
00945         sprintf(tform[col], <span class="stringliteral">""</span>);
00946         sprintf(tunit[col], <span class="stringliteral">""</span>);
00947       }
00948       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
00949         <span class="keywordflow">continue</span>;
00950 
00951       <span class="comment">// Add generic columns</span>
00952       col = <a class="code" href="_catalogue_8h.html#a4">OUTCAT_COL_ID_COLNUM</a> - 1;
00953       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a5">OUTCAT_COL_ID_NAME</a>);
00954       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a6">OUTCAT_COL_ID_FORM</a>);
00955       col = <a class="code" href="_catalogue_8h.html#a7">OUTCAT_COL_RA_COLNUM</a> - 1;
00956       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a8">OUTCAT_COL_RA_NAME</a>);
00957       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a9">OUTCAT_COL_RA_FORM</a>);
00958       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a10">OUTCAT_COL_RA_UNIT</a>);
00959       col = <a class="code" href="_catalogue_8h.html#a11">OUTCAT_COL_DEC_COLNUM</a> - 1;
00960       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a12">OUTCAT_COL_DEC_NAME</a>);
00961       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a13">OUTCAT_COL_DEC_FORM</a>);
00962       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a14">OUTCAT_COL_DEC_UNIT</a>);
00963       col = <a class="code" href="_catalogue_8h.html#a15">OUTCAT_COL_MAJERR_COLNUM</a> - 1;
00964       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a16">OUTCAT_COL_MAJERR_NAME</a>);
00965       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a17">OUTCAT_COL_MAJERR_FORM</a>);
00966       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a18">OUTCAT_COL_MAJERR_UNIT</a>);
00967       col = <a class="code" href="_catalogue_8h.html#a19">OUTCAT_COL_MINERR_COLNUM</a> - 1;
00968       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a20">OUTCAT_COL_MINERR_NAME</a>);
00969       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a21">OUTCAT_COL_MINERR_FORM</a>);
00970       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a22">OUTCAT_COL_MINERR_UNIT</a>);
00971       col = <a class="code" href="_catalogue_8h.html#a23">OUTCAT_COL_POSANGLE_COLNUM</a> - 1;
00972       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a24">OUTCAT_COL_POSANGLE_NAME</a>);
00973       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a25">OUTCAT_COL_POSANGLE_FORM</a>);
00974       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a26">OUTCAT_COL_POSANGLE_UNIT</a>);
00975       col = <a class="code" href="_catalogue_8h.html#a27">OUTCAT_COL_PROB_COLNUM</a> - 1;
00976       sprintf(ttype[col], <a class="code" href="_catalogue_8h.html#a28">OUTCAT_COL_PROB_NAME</a>);
00977       sprintf(tform[col], <a class="code" href="_catalogue_8h.html#a29">OUTCAT_COL_PROB_FORM</a>);
00978       sprintf(tunit[col], <a class="code" href="_catalogue_8h.html#a30">OUTCAT_COL_PROB_UNIT</a>);
00979 
00980       <span class="comment">// Initialise column counter for additional columns</span>
00981       col = <a class="code" href="_catalogue_8h.html#a3">OUTCAT_NUM_GENERIC</a>;
00982 
00983       <span class="comment">// Add source catalogue quantities</span>
00984       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o9">num_src_Qty</a>; iQty++) {
00985         <a class="code" href="classsource_identify_1_1_catalogue.html#o10">src_Qty_colnum</a>.push_back(col+1);
00986         sprintf(ttype[col], <span class="stringliteral">"SRC_%s"</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o11">src_Qty_ttype</a>[iQty].c_str());
00987         sprintf(tform[col], <a class="code" href="classsource_identify_1_1_catalogue.html#o12">src_Qty_tform</a>[iQty].c_str());
00988         sprintf(tunit[col], <a class="code" href="classsource_identify_1_1_catalogue.html#o13">src_Qty_tunit</a>[iQty].c_str());
00989         col++;
00990       }
00991 
00992       <span class="comment">// Add counterpart catalogue quantities</span>
00993       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o14">num_cpt_Qty</a>; iQty++) {
00994         <a class="code" href="classsource_identify_1_1_catalogue.html#o15">cpt_Qty_colnum</a>.push_back(col+1);
00995         sprintf(ttype[col], <span class="stringliteral">"CPT_%s"</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o16">cpt_Qty_ttype</a>[iQty].c_str());
00996         sprintf(tform[col], <a class="code" href="classsource_identify_1_1_catalogue.html#o17">cpt_Qty_tform</a>[iQty].c_str());
00997         sprintf(tunit[col], <a class="code" href="classsource_identify_1_1_catalogue.html#o18">cpt_Qty_tunit</a>[iQty].c_str());
00998         col++;
00999       }
01000 
01001       <span class="comment">// Create binary table</span>
01002       fstatus = fits_create_tbl(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, BINARY_TBL, 0, num_col, 
01003                                 ttype, tform, tunit,
01004                                 <a class="code" href="_catalogue_8h.html#a2">OUTCAT_EXT_NAME</a>, &amp;fstatus);
01005       <span class="keywordflow">if</span> (fstatus != 0) {
01006         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01007           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to create empty catalogue '%s'."</span>, 
01008               fstatus, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o2">m_outCatName</a>);
01009         <span class="keywordflow">continue</span>;
01010       }
01011    
01012     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01013 
01014     <span class="comment">// Free temporary memory</span>
01015     <span class="keywordflow">if</span> (ttype != NULL) {
01016       <span class="keywordflow">for</span> (col = 0; col &lt; num_col; col++) {
01017         <span class="keywordflow">if</span> (ttype[col] != NULL) <span class="keyword">delete</span> [] ttype[col];
01018       }
01019       <span class="keyword">delete</span> [] ttype;
01020     }
01021     <span class="keywordflow">if</span> (tform != NULL) {
01022       <span class="keywordflow">for</span> (col = 0; col &lt; num_col; col++) {
01023         <span class="keywordflow">if</span> (tform[col] != NULL) <span class="keyword">delete</span> [] tform[col];
01024       }
01025       <span class="keyword">delete</span> [] tform;
01026     }
01027     <span class="keywordflow">if</span> (tunit != NULL) {
01028       <span class="keywordflow">for</span> (col = 0; col &lt; num_col; col++) {
01029         <span class="keywordflow">if</span> (tunit[col] != NULL) <span class="keyword">delete</span> [] tunit[col];
01030       }
01031       <span class="keyword">delete</span> [] tunit;
01032     }
01033 
01034     <span class="comment">// Set FITSIO status</span>
01035     <span class="keywordflow">if</span> (status == <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01036       status = (Status)fstatus;
01037 
01038     <span class="comment">// Debug mode: Entry</span>
01039     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01040       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::create_output_catalogue (status=%d)"</span>, 
01041           status);
01042     
01043     <span class="comment">// Return status</span>
01044     <span class="keywordflow">return</span> status;
01045 
01046 }
01047 
01048 
01049 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01050 <span class="comment">/*                     Catalogue::add_counterpart_candidates                  */</span>
01051 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01052 <span class="comment">/* Private method: add counterpart candidates to internal FITS file           */</span>
01053 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01054"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c9">01054</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::add_counterpart_candidates(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <span class="keywordtype">long</span> iSrc, 
01055                                              <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01056 
01057     <span class="comment">// Declare local variables</span>
01058     <span class="keywordtype">int</span>           fstatus;
01059     <span class="keywordtype">int</span>           colnum;
01060     <span class="keywordtype">long</span>          nactrows;
01061     <span class="keywordtype">long</span>          firstrow;
01062     <span class="keywordtype">long</span>          row;
01063     <span class="keywordtype">long</span>          frow;
01064     <span class="keywordtype">long</span>          nrows;
01065     <span class="keywordtype">long</span>          iQty;
01066     <span class="keywordtype">long</span>          iCpt;
01067     <span class="keywordtype">double</span>        NValue;
01068     std::string   SValue;
01069     std::string   form;
01070     std::string   name;
01071     <span class="keywordtype">double</span>       *dptr;
01072     <span class="keywordtype">char</span>        **cptr;
01073 
01074     <span class="comment">// Debug mode: Entry</span>
01075     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01076       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::add_counterpart_candidates"</span>);
01077 
01078     <span class="comment">// Initialise temporary memory pointers</span>
01079     dptr = NULL;
01080     cptr = NULL;    
01081 
01082     <span class="comment">// Initialise FITSIO status</span>
01083     fstatus = (int)status;
01084 
01085     <span class="comment">// Single loop for common exit point</span>
01086     <span class="keywordflow">do</span> {
01087     
01088       <span class="comment">// Fall through in case of an error</span>
01089       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01090         <span class="keywordflow">continue</span>;
01091         
01092       <span class="comment">// Fall through if there are no counterpart candidates</span>
01093       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1)
01094         <span class="keywordflow">continue</span>;
01095 
01096       <span class="comment">// Determine number of rows in actual table</span>
01097       fstatus = fits_get_num_rows(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, &amp;nactrows, &amp;fstatus);
01098       <span class="keywordflow">if</span> (fstatus != 0) {
01099         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01100           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to determine number of rows in output"</span>
01101               <span class="stringliteral">" catalogue."</span>, fstatus);
01102         <span class="keywordflow">continue</span>;
01103       }
01104 
01105       <span class="comment">// Define the rows that should be inserted</span>
01106       firstrow = (long)nactrows;
01107       frow     = firstrow + 1;   
01108       nrows    = (long)<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>;
01109 
01110       <span class="comment">// Insert rows for the new counterpart candidates</span>
01111       fstatus = fits_insert_rows(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, firstrow, nrows, &amp;fstatus);
01112       <span class="keywordflow">if</span> (fstatus != 0) {
01113         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01114           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to add %d rows to output catalogue."</span>, 
01115               fstatus, nrows);
01116         <span class="keywordflow">continue</span>;
01117       }
01118 
01119       <span class="comment">// Allocate memory to hold quantities</span>
01120       dptr = <span class="keyword">new</span> <span class="keywordtype">double</span>[nrows];
01121       cptr = <span class="keyword">new</span> (<span class="keywordtype">char</span>*)[nrows];
01122       <span class="keywordflow">if</span> (dptr == NULL ||
01123           cptr == NULL) {
01124         status = <a class="code" href="namespacesource_identify.html#a38a25">STATUS_MEM_ALLOC</a>;
01125         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01126           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Memory allocation failure."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01127         <span class="keywordflow">continue</span>;
01128       }
01129       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++) {
01130         cptr[row] = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="_catalogue_8h.html#a0">OUTCAT_MAX_STRING_LEN</a>];
01131         <span class="keywordflow">if</span> (cptr[row] == NULL) {
01132           status = <a class="code" href="namespacesource_identify.html#a38a25">STATUS_MEM_ALLOC</a>;
01133           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01134             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Memory allocation failure."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01135           <span class="keywordflow">break</span>;
01136         }
01137       }
01138       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01139         <span class="keywordflow">continue</span>;
01140 
01141 
01142       <span class="comment">// Add unique counterpart identifier</span>
01143       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01144         strcpy(cptr[row], <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].id.c_str());
01145       fstatus = fits_write_col_str(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, <a class="code" href="_catalogue_8h.html#a4">OUTCAT_COL_ID_COLNUM</a>, 
01146                                    frow, 1, nrows, cptr, &amp;fstatus);
01147       <span class="keywordflow">if</span> (fstatus != 0) {
01148         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01149           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart identifier to output"</span>
01150               <span class="stringliteral">" catalogue."</span>, fstatus);
01151         <span class="keywordflow">continue</span>;
01152       }
01153 
01154       <span class="comment">// Add Counterpart Right Ascention</span>
01155       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01156         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m1">pos_eq_ra</a>;
01157       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a7">OUTCAT_COL_RA_COLNUM</a>,
01158                                frow, 1, nrows, dptr, &amp;fstatus);
01159       <span class="keywordflow">if</span> (fstatus != 0) {
01160         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01161           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart Right Ascension to"</span>
01162               <span class="stringliteral">" output catalogue."</span>, fstatus);
01163         <span class="keywordflow">continue</span>;
01164       }
01165 
01166       <span class="comment">// Add Counterpart Declination</span>
01167       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01168         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m2">pos_eq_dec</a>;
01169       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a11">OUTCAT_COL_DEC_COLNUM</a>,
01170                                frow, 1, nrows, dptr, &amp;fstatus);
01171       <span class="keywordflow">if</span> (fstatus != 0) {
01172         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01173           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart Declination to"</span>
01174               <span class="stringliteral">" output catalogue."</span>, fstatus);
01175         <span class="keywordflow">continue</span>;
01176       }
01177 
01178       <span class="comment">// Add Counterpart Error Ellipse Major Axis</span>
01179       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01180         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m3">pos_err_maj</a>;
01181       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a15">OUTCAT_COL_MAJERR_COLNUM</a>,
01182                                frow, 1, nrows, dptr, &amp;fstatus);
01183       <span class="keywordflow">if</span> (fstatus != 0) {
01184         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01185           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart error ellipse major"</span>
01186               <span class="stringliteral">" axis to output catalogue."</span>, fstatus);
01187         <span class="keywordflow">continue</span>;
01188       }
01189 
01190       <span class="comment">// Add Counterpart Error Ellipse Minor Axis</span>
01191       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01192         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m4">pos_err_min</a>;
01193       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a19">OUTCAT_COL_MINERR_COLNUM</a>,
01194                                frow, 1, nrows, dptr, &amp;fstatus);
01195       <span class="keywordflow">if</span> (fstatus != 0) {
01196         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01197           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart error ellipse minor"</span>
01198               <span class="stringliteral">" axis to output catalogue."</span>, fstatus);
01199         <span class="keywordflow">continue</span>;
01200       }
01201 
01202       <span class="comment">// Add Counterpart Error Ellipse Position Angle</span>
01203       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01204         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m5">pos_err_ang</a>;
01205       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a23">OUTCAT_COL_POSANGLE_COLNUM</a>,
01206                                frow, 1, nrows, dptr, &amp;fstatus);
01207       <span class="keywordflow">if</span> (fstatus != 0) {
01208         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01209           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart error ellipse position"</span>
01210               <span class="stringliteral">" angle to output catalogue."</span>, fstatus);
01211         <span class="keywordflow">continue</span>;
01212       }
01213 
01214       <span class="comment">// Add Counterpart Probability</span>
01215       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01216         dptr[row] = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a>;
01217       fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, <a class="code" href="_catalogue_8h.html#a27">OUTCAT_COL_PROB_COLNUM</a>,
01218                                frow, 1, nrows, dptr, &amp;fstatus);
01219       <span class="keywordflow">if</span> (fstatus != 0) {
01220         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01221           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart probability to output"</span>
01222               <span class="stringliteral">" catalogue."</span>, fstatus);
01223         <span class="keywordflow">continue</span>;
01224       }
01225 
01226       <span class="comment">// Add source catalogue columns</span>
01227       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o9">num_src_Qty</a>; iQty++) {
01228 
01229         <span class="comment">// Get column information</span>
01230         colnum = <a class="code" href="classsource_identify_1_1_catalogue.html#o10">src_Qty_colnum</a>[iQty];
01231         form   = <a class="code" href="classsource_identify_1_1_catalogue.html#o12">src_Qty_tform</a>[iQty];
01232         name   = <a class="code" href="classsource_identify_1_1_catalogue.html#o11">src_Qty_ttype</a>[iQty];
01233 
01234         <span class="comment">// Add numerical quantities</span>
01235         <span class="keywordflow">if</span> (form.find(<span class="stringliteral">"E"</span>, 0) != std::string::npos) {
01236           <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getNValue(name, iSrc, &amp;NValue);
01237           <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01238             dptr[row] = NValue;
01239           fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, colnum, frow, 1, nrows, 
01240                                    dptr, &amp;fstatus);
01241           <span class="keywordflow">if</span> (fstatus != 0) {
01242             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01243               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write source catalogue data &lt;%s&gt;"</span>
01244                   <span class="stringliteral">" (column %d) to output catalogue."</span>, 
01245                   fstatus, name.c_str(), colnum);
01246             <span class="keywordflow">break</span>;
01247           }
01248         } <span class="comment">// endif: added numerical quantities</span>
01249 
01250         <span class="comment">// Add string quantities</span>
01251         <span class="keywordflow">if</span> (form.find(<span class="stringliteral">"A"</span>, 0) != std::string::npos) {
01252           <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getSValue(name, iSrc, &amp;SValue);
01253           <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++)
01254             strcpy(cptr[row], SValue.c_str());
01255           fstatus = fits_write_col_str(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, colnum, frow, 1, nrows, cptr, 
01256                                        &amp;fstatus);
01257           <span class="keywordflow">if</span> (fstatus != 0) {
01258             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01259               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write source catalogue data &lt;%s&gt;"</span>
01260                   <span class="stringliteral">" (column %d) to output catalogue."</span>, 
01261                   fstatus, name.c_str(), colnum);
01262             <span class="keywordflow">break</span>;
01263           }
01264         } <span class="comment">// endif: added numerical quantities</span>
01265 
01266       }
01267       <span class="keywordflow">if</span> (fstatus != 0)
01268         <span class="keywordflow">continue</span>;
01269 
01270       <span class="comment">// Add counterpart catalogue columns</span>
01271       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o14">num_cpt_Qty</a>; iQty++) {
01272 
01273         <span class="comment">// Get column information</span>
01274         colnum = <a class="code" href="classsource_identify_1_1_catalogue.html#o15">cpt_Qty_colnum</a>[iQty];
01275         form   = <a class="code" href="classsource_identify_1_1_catalogue.html#o17">cpt_Qty_tform</a>[iQty];
01276         name   = <a class="code" href="classsource_identify_1_1_catalogue.html#o16">cpt_Qty_ttype</a>[iQty];
01277 
01278         <span class="comment">// Add numerical quantities</span>
01279         <span class="keywordflow">if</span> (form.find(<span class="stringliteral">"E"</span>, 0) != std::string::npos) {
01280           <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++) {
01281             iCpt = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m7">index</a>;
01282             <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getNValue(name, iCpt, &amp;NValue);
01283             dptr[row] = NValue;
01284           }
01285           fstatus = fits_write_col(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, TDOUBLE, colnum, frow, 1, nrows, 
01286                                    dptr, &amp;fstatus);
01287           <span class="keywordflow">if</span> (fstatus != 0) {
01288             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01289               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart catalogue data &lt;%s&gt;"</span>
01290                   <span class="stringliteral">" (column %d) to output catalogue."</span>, 
01291                   fstatus, name.c_str(), colnum);
01292             <span class="keywordflow">break</span>;
01293           }
01294         } <span class="comment">// endif: added numerical quantities</span>
01295 
01296         <span class="comment">// Add string quantities</span>
01297         <span class="keywordflow">if</span> (form.find(<span class="stringliteral">"A"</span>, 0) != std::string::npos) {
01298           <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++) {
01299             iCpt = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[row].<a class="code" href="structsource_identify_1_1_c_c_element.html#m7">index</a>;
01300             <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getSValue(name, iCpt, &amp;SValue);
01301             strcpy(cptr[row], SValue.c_str());
01302           }
01303           fstatus = fits_write_col_str(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, colnum, frow, 1, nrows, cptr, 
01304                                        &amp;fstatus);
01305           <span class="keywordflow">if</span> (fstatus != 0) {
01306             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01307               <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to write counterpart catalogue data"</span>
01308                   <span class="stringliteral">" &lt;%s&gt; (column %d) to output catalogue."</span>, 
01309                   fstatus, name.c_str(), colnum);
01310             <span class="keywordflow">break</span>;
01311           }
01312         } <span class="comment">// endif: added numerical quantities</span>
01313 
01314       }
01315       <span class="keywordflow">if</span> (fstatus != 0)
01316         <span class="keywordflow">continue</span>;
01317    
01318     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01319 
01320     <span class="comment">// Delete temporary memory</span>
01321     <span class="keywordflow">if</span> (dptr != NULL) <span class="keyword">delete</span> [] dptr;
01322     <span class="keywordflow">if</span> (cptr != NULL) {
01323       <span class="keywordflow">for</span> (row = 0; row &lt; nrows; row++) {
01324         <span class="keywordflow">if</span> (cptr[row] != NULL) <span class="keyword">delete</span> [] cptr[row];
01325       }
01326       <span class="keyword">delete</span> [] cptr;
01327     }
01328 
01329     <span class="comment">// Set FITSIO status</span>
01330     <span class="keywordflow">if</span> (status == <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01331       status = (Status)fstatus;
01332 
01333     <span class="comment">// Debug mode: Entry</span>
01334     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01335       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::add_counterpart_candidates (status=%d)"</span>, 
01336           status);
01337     
01338     <span class="comment">// Return status</span>
01339     <span class="keywordflow">return</span> status;
01340 
01341 }
01342 
01343 
01344 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01345 <span class="comment">/*                Catalogue::eval_output_catalogue_quantities                 */</span>
01346 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01347 <span class="comment">/* Private method: evaluate output catalogue quantities                       */</span>
01348 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01349"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c10">01349</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::eval_output_catalogue_quantities(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, 
01350                                                    <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01351 
01352     <span class="comment">// Declare local variables</span>
01353     <span class="keywordtype">int</span>                    fstatus;
01354     <span class="keywordtype">int</span>                    datatype;
01355     <span class="keywordtype">int</span>                    naxis;
01356     <span class="keywordtype">long</span>                   nelements;
01357     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>          iQty;
01358     std::string::size_type numQty;
01359     std::string            tform;
01360 
01361     <span class="comment">// Debug mode: Entry</span>
01362     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01363       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::eval_output_catalogue_quantities"</span>);
01364 
01365     <span class="comment">// Initialise FITSIO status</span>
01366     fstatus = (int)status;
01367 
01368     <span class="comment">// Single loop for common exit point</span>
01369     <span class="keywordflow">do</span> {
01370     
01371       <span class="comment">// Fall through in case of an error</span>
01372       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01373         <span class="keywordflow">continue</span>;
01374 
01375       <span class="comment">// Determine number of new output catalogue quantities. Fall through if</span>
01376       <span class="comment">// there are no new output catalogue quantities</span>
01377       numQty = par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o5">m_outCatQtyName</a>.size();
01378       <span class="keywordflow">if</span> (numQty &lt; 1)
01379         <span class="keywordflow">continue</span>;
01380 
01381       <span class="comment">// Dump header</span>
01382       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01383         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">""</span>);
01384         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"Add new output catalogue quantities:"</span>);
01385         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"===================================="</span>);
01386       }
01387 
01388       <span class="comment">// Add all new output catalogue quantities</span>
01389       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; numQty; iQty++) {
01390 
01391         <span class="comment">// Test expression to determine the format of the new column</span>
01392         fstatus = fits_test_expr(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>,
01393                                  par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o6">m_outCatQtyFormula</a>[iQty].c_str(),
01394                                  0, &amp;datatype, &amp;nelements, &amp;naxis, NULL,
01395                                  &amp;fstatus);
01396         <span class="keywordflow">if</span> (fstatus != 0) {
01397           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01398             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">" Unable to evaluate expression &lt;%s='%s'&gt; for"</span>
01399                 <span class="stringliteral">" creating new output catalogue quantity (status=%d)."</span>,
01400                 par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o5">m_outCatQtyName</a>[iQty].c_str(), 
01401                 par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o6">m_outCatQtyFormula</a>[iQty].c_str(),
01402                 fstatus);
01403           fstatus = 0;
01404           <span class="keywordflow">continue</span>;
01405         }
01406 
01407         <span class="comment">// Set column format</span>
01408         <span class="keywordflow">if</span> (nelements &lt; 1) 
01409           nelements = 1;
01410         <a class="code" href="namespacesource_identify.html#a33">fits_tform_binary</a>(datatype, nelements, 0, &amp;tform);
01411 
01412         <span class="comment">// Create new FITS column</span>
01413         fstatus = fits_calculator(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, 
01414                                   par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o6">m_outCatQtyFormula</a>[iQty].c_str(),
01415                                   <a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>,
01416                                   par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o5">m_outCatQtyName</a>[iQty].c_str(),
01417                                   tform.c_str(), 
01418                                   &amp;fstatus);
01419         <span class="keywordflow">if</span> (fstatus != 0) {
01420           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01421             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to evaluate quantity &lt;%s='%s'&gt; in output"</span>
01422                 <span class="stringliteral">" catalogue."</span>, 
01423                 fstatus, 
01424                 par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o5">m_outCatQtyName</a>[iQty].c_str(), 
01425                 par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o6">m_outCatQtyFormula</a>[iQty].c_str());
01426           <span class="keywordflow">break</span>;
01427         }
01428 
01429         <span class="comment">// Dump new output catalogue quantities information</span>
01430         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01431           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" New quantity .....................: %s = %s"</span>
01432               <span class="stringliteral">" (format='%s')"</span>,
01433               par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o5">m_outCatQtyName</a>[iQty].c_str(),
01434               par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o6">m_outCatQtyFormula</a>[iQty].c_str(),
01435               tform.c_str());
01436         }
01437 
01438       }
01439       <span class="keywordflow">if</span> (fstatus != 0)
01440         <span class="keywordflow">continue</span>;
01441 
01442     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01443 
01444     <span class="comment">// Set FITSIO status</span>
01445     <span class="keywordflow">if</span> (status == <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01446       status = (Status)fstatus;
01447 
01448     <span class="comment">// Debug mode: Entry</span>
01449     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01450       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::eval_output_catalogue_quantities"</span>
01451           <span class="stringliteral">" (status=%d)"</span>, status);
01452     
01453     <span class="comment">// Return status</span>
01454     <span class="keywordflow">return</span> status;
01455 
01456 }
01457 
01458 
01459 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01460 <span class="comment">/*                      Catalogue::select_output_catalogue                    */</span>
01461 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01462 <span class="comment">/* Private method: select output catalogue entries                            */</span>
01463 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01464"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c11">01464</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::select_output_catalogue(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01465 
01466     <span class="comment">// Declare local variables</span>
01467     <span class="keywordtype">int</span>                    fstatus;
01468     <span class="keywordtype">long</span>                   numBefore;
01469     <span class="keywordtype">long</span>                   numAfter;
01470     std::string::size_type iSel;
01471     std::string::size_type numSel;
01472 
01473     <span class="comment">// Debug mode: Entry</span>
01474     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01475       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::select_output_catalogue"</span>);
01476 
01477     <span class="comment">// Initialise FITSIO status</span>
01478     fstatus = (int)status;
01479 
01480     <span class="comment">// Single loop for common exit point</span>
01481     <span class="keywordflow">do</span> {
01482     
01483       <span class="comment">// Fall through in case of an error</span>
01484       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01485         <span class="keywordflow">continue</span>;
01486 
01487       <span class="comment">// Determine number of output catalogue selection strings. Fall through</span>
01488       <span class="comment">// if there are no such strings</span>
01489       numSel = par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o7">m_select</a>.size();
01490       <span class="keywordflow">if</span> (numSel &lt; 1)
01491         <span class="keywordflow">continue</span>;
01492 
01493       <span class="comment">// Dump header</span>
01494       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01495         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">""</span>);
01496         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"Select output catalogue counterparts:"</span>);
01497         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"====================================="</span>);
01498       }
01499 
01500       <span class="comment">// Select output catalogue entries</span>
01501       <span class="keywordflow">for</span> (iSel = 0; iSel &lt; numSel; iSel++) {
01502 
01503         <span class="comment">// Determine number of rows in table before selection</span>
01504         fstatus = fits_get_num_rows(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, &amp;numBefore, &amp;fstatus);
01505         <span class="keywordflow">if</span> (fstatus != 0) {
01506           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01507             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to determine number of rows in output"</span>
01508                 <span class="stringliteral">" catalogue."</span>, fstatus);
01509           <span class="keywordflow">break</span>;
01510         }
01511 
01512         <span class="comment">// Perform selection</span>
01513         fstatus = fits_select_rows(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, <a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>,
01514                                    par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o7">m_select</a>[iSel].c_str(),
01515                                    &amp;fstatus);
01516         <span class="keywordflow">if</span> (fstatus != 0) {
01517           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01518             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a14">Warning_2</a>, <span class="stringliteral">" Unable to perform selection &lt;%s&gt; on the output"</span>
01519                 <span class="stringliteral">" catalogue (status=%d)."</span>,
01520                 par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o7">m_select</a>[iSel].c_str(), 
01521                 fstatus);
01522           fstatus = 0;
01523           <span class="keywordflow">continue</span>;
01524         }
01525 
01526         <span class="comment">// Determine number of rows in table after selection</span>
01527         fstatus = fits_get_num_rows(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, &amp;numAfter, &amp;fstatus);
01528         <span class="keywordflow">if</span> (fstatus != 0) {
01529           <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01530             <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to determine number of rows in output"</span>
01531                 <span class="stringliteral">" catalogue."</span>, fstatus);
01532           <span class="keywordflow">break</span>;
01533         }
01534 
01535         <span class="comment">// Dump selection information</span>
01536         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01537           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Selection ........................: %s"</span>, 
01538               par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o7">m_select</a>[iSel].c_str());
01539           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"   Number of deleted counterparts .: %d (%d =&gt; %d)"</span>, 
01540               numBefore-numAfter, numBefore, numAfter);
01541         }
01542 
01543       }
01544       <span class="keywordflow">if</span> (fstatus != 0)
01545         <span class="keywordflow">continue</span>;
01546 
01547     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01548 
01549     <span class="comment">// Set FITSIO status</span>
01550     <span class="keywordflow">if</span> (status == <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01551       status = (Status)fstatus;
01552 
01553     <span class="comment">// Debug mode: Entry</span>
01554     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01555       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::select_output_catalogue (status=%d)"</span>, 
01556           status);
01557     
01558     <span class="comment">// Return status</span>
01559     <span class="keywordflow">return</span> status;
01560 
01561 }
01562 
01563 
01564 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01565 <span class="comment">/*                             Catalogue::cc_sort                             */</span>
01566 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01567 <span class="comment">/* Private method: sort counterpart candidates by increasing probability      */</span>
01568 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01569"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c12">01569</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::cc_sort(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01570 
01571     <span class="comment">// Declare local variables</span>
01572     <span class="keywordtype">long</span>      iCC;
01573     <span class="keywordtype">long</span>      jCC;
01574     <span class="keywordtype">long</span>      imax;
01575     <span class="keywordtype">double</span>    max;
01576     <a class="code" href="structsource_identify_1_1_c_c_element.html">CCElement</a> swap;
01577 
01578     <span class="comment">// Debug mode: Entry</span>
01579     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01580       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::cc_sort"</span>);
01581 
01582     <span class="comment">// Single loop for common exit point</span>
01583     <span class="keywordflow">do</span> {
01584     
01585       <span class="comment">// Fall through in case of an error</span>
01586       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01587         <span class="keywordflow">continue</span>;
01588         
01589       <span class="comment">// Fall through if there are no counterpart candidates</span>
01590       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1)
01591         <span class="keywordflow">continue</span>;
01592     
01593       <span class="comment">// Sort counterpart candidats (dirty brute force method, to be replaced</span>
01594       <span class="comment">// by more efficient method if needed ...)</span>
01595       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++) {
01596         max  = 0.0;
01597         imax = iCC;
01598         <span class="keywordflow">for</span> (jCC = iCC; jCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; jCC++) {
01599           <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[jCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a> &gt; max) {
01600             imax = jCC;
01601             max  = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[jCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a>;
01602           }
01603         }
01604         <span class="keywordflow">if</span> (iCC != imax) {
01605           swap     = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC];
01606           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC]  = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[imax];
01607           <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[imax] = swap;
01608         } 
01609       }
01610     
01611     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01612 
01613     <span class="comment">// Debug mode: Entry</span>
01614     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01615       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::cc_sort (status=%d)"</span>, status);
01616     
01617     <span class="comment">// Return status</span>
01618     <span class="keywordflow">return</span> status;
01619 
01620 }
01621 
01622 
01623 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01624 <span class="comment">/*                          Catalogue::dump_descriptor                        */</span>
01625 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01626 <span class="comment">/* Private method: dump catalogue descriptor                                  */</span>
01627 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01628"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c13">01628</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::dump_descriptor(catalogAccess::Catalog *cat, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01629 
01630     <span class="comment">// Declare local variables</span>
01631     <span class="keywordtype">long</span>                                               iQty;
01632     <span class="keywordtype">long</span>                                               numQty;
01633     <span class="keywordtype">long</span>                                               numRows;
01634     <span class="keywordtype">long</span>                                               len;
01635     <span class="keywordtype">long</span>                                               maxLenNames;
01636     <span class="keywordtype">long</span>                                               maxLenUnits;
01637     <span class="keywordtype">long</span>                                               maxLenUCDs;
01638     std::string                                        qtyType;
01639     std::vector&lt;std::string&gt;                           titles;
01640     std::vector&lt;std::string&gt;                           qtyNames;
01641     std::vector&lt;std::string&gt;                           qtyUnits;
01642     std::vector&lt;std::string&gt;                           qtyUCDs;
01643     std::vector&lt;catalogAccess::Quantity&gt;               qtyDesc;
01644     std::vector&lt;catalogAccess::Quantity::QuantityType&gt; qtyTypes;
01645 
01646     <span class="comment">// Single loop for common exit point</span>
01647     <span class="keywordflow">do</span> {
01648       
01649       <span class="comment">// Extract information from catalogue</span>
01650       cat-&gt;getCatalogTitles(&amp;titles);
01651       numQty = cat-&gt;getQuantityNames(&amp;qtyNames);
01652       numQty = cat-&gt;getQuantityUnits(&amp;qtyUnits);
01653       numQty = cat-&gt;getQuantityUCDs(&amp;qtyUCDs);
01654       numQty = cat-&gt;getQuantityDescription(&amp;qtyDesc);
01655       numQty = cat-&gt;getQuantityTypes(&amp;qtyTypes);
01656       cat-&gt;getNumRows(&amp;numRows);
01657       
01658       <span class="comment">// Get string lengths</span>
01659       maxLenNames = 0;
01660       maxLenUnits = 0;
01661       maxLenUCDs  = 0;
01662       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; numQty; iQty++) {
01663         <span class="keywordflow">if</span> ((len = strlen(qtyNames[iQty].c_str())) &gt; maxLenNames)
01664           maxLenNames = len;
01665         <span class="keywordflow">if</span> ((len = strlen(qtyUnits[iQty].c_str())) &gt; maxLenUnits)
01666           maxLenUnits = len;
01667         <span class="keywordflow">if</span> ((len = strlen(qtyUCDs[iQty].c_str())) &gt; maxLenUCDs)
01668           maxLenUCDs = len;
01669       }
01670 
01671       <span class="comment">// Dump catalogue information</span>
01672       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Catalogue ........................: %s"</span>, titles[0].c_str());
01673       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Number of entries (rows) .........: %d"</span>, numRows);
01674       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Number of quantities (columns) ...: %d"</span>, numQty);
01675 
01676       <span class="comment">// Dump information about catalogue quantitites</span>
01677       <span class="keywordflow">for</span> (iQty = 0; iQty &lt; numQty; iQty++) {
01678       
01679         <span class="comment">// Set quantity type</span>
01680         <span class="keywordflow">switch</span> (qtyTypes[iQty]) {
01681         <span class="keywordflow">case</span> 0:
01682           qtyType = <span class="stringliteral">"vector ("</span> + qtyDesc[iQty].m_format + <span class="stringliteral">")"</span>;
01683           <span class="keywordflow">break</span>;
01684         <span class="keywordflow">case</span> 1:
01685           qtyType = <span class="stringliteral">"numerical ("</span> + qtyDesc[iQty].m_format + <span class="stringliteral">")"</span>;
01686           <span class="keywordflow">break</span>;
01687         <span class="keywordflow">case</span> 2:
01688           qtyType = <span class="stringliteral">"string ("</span> + qtyDesc[iQty].m_format + <span class="stringliteral">")"</span>;
01689           <span class="keywordflow">break</span>;
01690         <span class="keywordflow">default</span>:
01691           qtyType = <span class="stringliteral">"unknown"</span>;
01692           <span class="keywordflow">break</span>;
01693         }
01694         
01695         <span class="comment">// Dump quantity</span>
01696         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Quantity %3d ....................: %*s %*s %*s (%s)"</span>, 
01697                  iQty+1, 
01698                  maxLenNames, qtyNames[iQty].c_str(),
01699                  maxLenUnits, qtyUnits[iQty].c_str(),
01700                  maxLenUCDs, qtyUCDs[iQty].c_str(),
01701                  qtyType.c_str());
01702 
01703       } <span class="comment">// endfor: looped over quantities</span>
01704     
01705     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01706     
01707     <span class="comment">// Return status</span>
01708     <span class="keywordflow">return</span> status;
01709 
01710 }
01711 
01712 
01713 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01714 <span class="comment">/*                    Catalogue::dump_counterpart_candidates                  */</span>
01715 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01716 <span class="comment">/* Private method: dump counterpart candidates that are actually in buffer    */</span>
01717 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01718"></a><a class="code" href="classsource_identify_1_1_catalogue.html#c14">01718</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::dump_counterpart_candidates(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01719 
01720     <span class="comment">// Declare local variables</span>
01721     <span class="keywordtype">long</span>        iCC;
01722     <span class="keywordtype">long</span>        iCpt;
01723     <span class="keywordtype">double</span>      cpt_ra;
01724     <span class="keywordtype">double</span>      cpt_dec;
01725     <span class="keywordtype">double</span>      cpt_error;
01726     std::string cpt_name;
01727     std::string obj_name;
01728 
01729     <span class="comment">// Debug mode: Entry</span>
01730     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01731       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::dump_counterpart_candidates"</span>);
01732 
01733     <span class="comment">// Single loop for common exit point</span>
01734     <span class="keywordflow">do</span> {
01735     
01736       <span class="comment">// Fall through in case of an error</span>
01737       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01738         <span class="keywordflow">continue</span>;
01739         
01740       <span class="comment">// Fall through if there are no counterpart candidates</span>
01741       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a> &lt; 1)
01742         <span class="keywordflow">continue</span>;
01743 
01744       <span class="comment">// Determine the name of the generic quantity "object name"</span>
01745       obj_name = <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getNameObjName();
01746     
01747       <span class="comment">// Loop over counterpart candidates</span>
01748       <span class="keywordflow">for</span> (iCC = 0; iCC &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o7">numCC</a>; iCC++) {
01749       
01750         <span class="comment">// Get index of candidate in counterpart catalogue</span>
01751         iCpt = <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m7">index</a>;
01752 
01753         <span class="comment">// Extract information for counterpart candidate</span>
01754         <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.ra_deg(iCpt,  &amp;cpt_ra);
01755         <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.dec_deg(iCpt, &amp;cpt_dec);
01756         <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.posError_deg(iCpt, &amp;cpt_error);
01757         <a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>.getSValue(obj_name, iCpt, &amp;cpt_name);
01758 
01759         <span class="comment">// Dump counterpart candidate information</span>
01760         <span class="keywordflow">if</span> (!par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>()) {
01761           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Counterpart candidate %5d .....: %s Prob=%7.3f %%"</span>,
01762               iCC+1, cpt_name.c_str(), <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a>*100.0);
01763         }
01764         <span class="keywordflow">else</span> {
01765           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"  Counterpart candidate %5d .....: %s Prob=%7.3f %%"</span>
01766               <span class="stringliteral">" (RA,DEC)=(%8.3f,%8.3f) +/- %8.3f  Sep=%8.3f deg"</span>,
01767               iCC+1, cpt_name.c_str(), <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m6">prob</a>*100.0,
01768               cpt_ra, cpt_dec, cpt_error, <a class="code" href="classsource_identify_1_1_catalogue.html#o8">cc</a>[iCC].<a class="code" href="structsource_identify_1_1_c_c_element.html#m8">angsep</a>);
01769         }
01770 
01771       } <span class="comment">// endfor: looped over counterpart candidats</span>
01772     
01773     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01774 
01775     <span class="comment">// Debug mode: Entry</span>
01776     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01777       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::dump_counterpart_candidates"</span>
01778           <span class="stringliteral">" (status=%d)"</span>, status);
01779     
01780     <span class="comment">// Return status</span>
01781     <span class="keywordflow">return</span> status;
01782 
01783 }
01784 
01785 
01786 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01787 <span class="comment">/*                              Catalogue::build                              */</span>
01788 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01789 <span class="comment">/* Build counterpart catalogue.                                               */</span>
01790 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01791 <span class="comment">/* build                                                                      */</span>
01792 <span class="comment">/*   |                                                                        */</span>
01793 <span class="comment">/*   +-- get_input_descriptor (get source catalogue input descriptior)        */</span>
01794 <span class="comment">/*   |                                                                        */</span>
01795 <span class="comment">/*   +-- get_input_descriptor (get counterpart catalogue input descriptior)   */</span>
01796 <span class="comment">/*   |                                                                        */</span>
01797 <span class="comment">/*   +-- create_output_catalogue (create output catalogue)                    */</span>
01798 <span class="comment">/*   |                                                                        */</span>
01799 <span class="comment">/*   +-- get_input_catalogue (get source catalogue)                           */</span>
01800 <span class="comment">/*   |                                                                        */</span>
01801 <span class="comment">/*   N-- get_counterpart_candidates (get counterpart candidates for each src) */</span>
01802 <span class="comment">/*   |   |                                                                    */</span>
01803 <span class="comment">/*   |   +-- get_counterparts (filter step)                                   */</span>
01804 <span class="comment">/*   |   |   |                                                                */</span>
01805 <span class="comment">/*   |   |   +-- get_input_catalogue (get counterpart catalogue)              */</span>
01806 <span class="comment">/*   |   |                                                                    */</span>
01807 <span class="comment">/*   |   +-- get_probability (refine step)                                    */</span>
01808 <span class="comment">/*   |   |   |                                                                */</span>
01809 <span class="comment">/*   |   |   +-- get_probability_angsep (get probability from angular sep.)   */</span>
01810 <span class="comment">/*   |   |   |                                                                */</span>
01811 <span class="comment">/*   |   |   +-- cc_sort (sort counterpart candidates by decreasing prob.)    */</span>
01812 <span class="comment">/*   |   |                                                                    */</span>
01813 <span class="comment">/*   |   +-- add_counterpart_candidates (add candidates to output catalogue)  */</span>
01814 <span class="comment">/*   |   |                                                                    */</span>
01815 <span class="comment">/*   |   +-- dump_counterpart_candidates (dump candidates to output catalogue)*/</span>
01816 <span class="comment">/*   |                                                                        */</span>
01817 <span class="comment">/*   +-- eval_output_catalogue_quantities (evaluate output catalogue qties)   */</span>
01818 <span class="comment">/*   |                                                                        */</span>
01819 <span class="comment">/*   +-- select_output_catalogue (select output catalogue entries)            */</span>
01820 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01821"></a><a class="code" href="classsource_identify_1_1_catalogue.html#a2">01821</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::build(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01822 
01823     <span class="comment">// Declare local variables</span>
01824     <span class="keywordtype">long</span> iSrc;
01825 
01826     <span class="comment">// Debug mode: Entry</span>
01827     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01828       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::build"</span>);
01829         
01830     <span class="comment">// Single loop for common exit point</span>
01831     <span class="keywordflow">do</span> {
01832 
01833       <span class="comment">// Fall through in case of an error</span>
01834       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01835         <span class="keywordflow">continue</span>;
01836 
01837       <span class="comment">// Dump header</span>
01838       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01839         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">""</span>);
01840         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"Build counterpart candidate catalogue:"</span>);
01841         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"======================================"</span>);
01842       }
01843       
01844       <span class="comment">// Get input catalogue descriptors</span>
01845       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c2">get_input_descriptor</a>(par, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o0">m_srcCatName</a>, &amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>, status);
01846       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01847         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01848           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load source catalogue '%s' descriptor."</span>,
01849               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o0">m_srcCatName</a>.c_str());
01850         <span class="keywordflow">continue</span>;
01851       }
01852       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c2">get_input_descriptor</a>(par, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o1">m_cptCatName</a>, &amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o5">cpt</a>, status);
01853       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01854         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01855           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load counterpart catalogue '%s'"</span>
01856               <span class="stringliteral">" descriptor."</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o1">m_cptCatName</a>.c_str());
01857         <span class="keywordflow">continue</span>;
01858       }
01859 
01860       <span class="comment">// Create output catalogue</span>
01861       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c8">create_output_catalogue</a>(par, status);
01862       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01863         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01864           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to create output catalogue."</span>,
01865               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01866         <span class="keywordflow">continue</span>;
01867       }
01868       
01869       <span class="comment">// Load source catalogue</span>
01870       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c3">get_input_catalogue</a>(par, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o0">m_srcCatName</a>, &amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>, status);
01871       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01872         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01873           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to load source catalogue '%s' data."</span>,
01874               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status, par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#o0">m_srcCatName</a>.c_str());
01875         <span class="keywordflow">continue</span>;
01876       }
01877       <span class="keywordflow">else</span> {
01878         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
01879           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Source catalogue loaded."</span>);
01880       }
01881       
01882       <span class="comment">// Determine the number of sources in source catalogue. Stop of the</span>
01883       <span class="comment">// catalogue is empty</span>
01884       <a class="code" href="classsource_identify_1_1_catalogue.html#o4">src</a>.getNumRows(&amp;<a class="code" href="classsource_identify_1_1_catalogue.html#o0">numSrc</a>);
01885       <span class="keywordflow">if</span> (<a class="code" href="classsource_identify_1_1_catalogue.html#o0">numSrc</a> &lt; 1) {
01886         status = <a class="code" href="namespacesource_identify.html#a38a31">STATUS_CAT_EMPTY</a>;
01887         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01888           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Source catalogue is empty. Stop"</span>, (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01889         <span class="keywordflow">continue</span>;
01890       }
01891       <span class="keywordflow">else</span> {
01892         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a7">logVerbose</a>())
01893           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">" Source catalogue contains %d sources."</span>, <a class="code" href="classsource_identify_1_1_catalogue.html#o0">numSrc</a>);
01894       }
01895       
01896       <span class="comment">// Loop over all sources</span>
01897       <span class="keywordflow">for</span> (iSrc = 0; iSrc &lt; <a class="code" href="classsource_identify_1_1_catalogue.html#o0">numSrc</a>; iSrc++) {
01898       
01899         <span class="comment">// Get counterpart candidates for the source</span>
01900         status = <a class="code" href="classsource_identify_1_1_catalogue.html#c4">get_counterpart_candidates</a>(par, iSrc, status);
01901         <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01902           <span class="keywordflow">break</span>;
01903       
01904       } <span class="comment">// endfor: looped over all sources</span>
01905       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01906         <span class="keywordflow">continue</span>;
01907 
01908       <span class="comment">// Evaluate output catalogue quantities</span>
01909       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c10">eval_output_catalogue_quantities</a>(par, status);
01910       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01911         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01912           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to evaluate output catalogue quantities."</span>,
01913               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01914         <span class="keywordflow">continue</span>;
01915       }
01916 
01917       <span class="comment">// Select output catalogue counterparts</span>
01918       status = <a class="code" href="classsource_identify_1_1_catalogue.html#c11">select_output_catalogue</a>(par, status);
01919       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>) {
01920         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01921           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to select output catalogue counterparts."</span>,
01922               (<a class="code" href="namespacesource_identify.html#a38">Status</a>)status);
01923         <span class="keywordflow">continue</span>;
01924       }
01925       
01926     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01927 
01928     <span class="comment">// Debug mode: Entry</span>
01929     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01930       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::build (status=%d)"</span>, status);
01931     
01932     <span class="comment">// Return status</span>
01933     <span class="keywordflow">return</span> status;
01934 
01935 }
01936 
01937 
01938 <span class="comment">/*----------------------------------------------------------------------------*/</span>
01939 <span class="comment">/*                               Catalogue::save                              */</span>
01940 <span class="comment">/* -------------------------------------------------------------------------- */</span>
01941 <span class="comment">/* Save counterpart catalogue.                                                */</span>
01942 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l01943"></a><a class="code" href="classsource_identify_1_1_catalogue.html#a3">01943</a> <a class="code" href="namespacesource_identify.html#a38">Status</a> Catalogue::save(<a class="code" href="classsource_identify_1_1_parameters.html">Parameters</a> *par, <a class="code" href="namespacesource_identify.html#a38">Status</a> status) {
01944 
01945     <span class="comment">// Declare local variables</span>
01946     <span class="keywordtype">int</span> fstatus;
01947 
01948     <span class="comment">// Debug mode: Entry</span>
01949     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01950       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" ==&gt; ENTRY: Catalogue::save"</span>);
01951         
01952     <span class="comment">// Initialise FITSIO status</span>
01953     fstatus = (int)status;
01954         
01955     <span class="comment">// Single loop for common exit point</span>
01956     <span class="keywordflow">do</span> {
01957 
01958       <span class="comment">// Fall through in case of an error</span>
01959       <span class="keywordflow">if</span> (status != <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01960         <span class="keywordflow">continue</span>;
01961 
01962       <span class="comment">// Dump header</span>
01963       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a5">logNormal</a>()) {
01964         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">""</span>);
01965         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"Save counterpart candidate catalogue:"</span>);
01966         <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a22">Log_2</a>, <span class="stringliteral">"====================================="</span>);
01967       }
01968 
01969       <span class="comment">// Close FITS file</span>
01970       fstatus = fits_close_file(<a class="code" href="classsource_identify_1_1_catalogue.html#o6">outFile</a>, &amp;fstatus);
01971       <span class="keywordflow">if</span> (fstatus != 0) {
01972         <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a4">logTerse</a>())
01973           <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a10">Error_2</a>, <span class="stringliteral">"%d : Unable to close output catalogue."</span>, fstatus);
01974         <span class="keywordflow">continue</span>;
01975       }
01976     
01977     } <span class="keywordflow">while</span> (0); <span class="comment">// End of main do-loop</span>
01978     
01979     <span class="comment">// Set FITSIO status</span>
01980     <span class="keywordflow">if</span> (status == <a class="code" href="namespacesource_identify.html#a38a24">STATUS_OK</a>)
01981       status = (Status)fstatus;
01982 
01983     <span class="comment">// Debug mode: Entry</span>
01984     <span class="keywordflow">if</span> (par-&gt;<a class="code" href="classsource_identify_1_1_parameters.html#a8">logDebug</a>())
01985       <a class="code" href="namespacesource_identify.html#a36">Log</a>(<a class="code" href="namespacesource_identify.html#a37a20">Log_0</a>, <span class="stringliteral">" &lt;== EXIT: Catalogue::save (status=%d)"</span>, status);
01986     
01987     <span class="comment">// Return status</span>
01988     <span class="keywordflow">return</span> status;
01989 
01990 }
01991 
01992 <span class="comment">/* Namespace ends ___________________________________________________________ */</span>
01993 }
</pre></div><hr><address style="align: right;"><small>Generated on Thu Jul 21 21:03:37 2005 for sourceIdentify by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
